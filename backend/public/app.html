<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ASDåœ°æ¿æ—¶å…‰å¹²é¢„ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
            padding-bottom: 70px;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .header .user-info {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        /* é¡µé¢åˆ‡æ¢ */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .card-title .icon {
            font-size: 20px;
            margin-right: 8px;
        }

        /* è¡¨å•å…ƒç´  */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        /* æŒ‰é’® */
        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-outline {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
        }

        /* å¿«æ·è®°å½•æŒ‰é’® */
        .quick-record-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .quick-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 12px;
            font-size: 28px;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .quick-btn:active {
            transform: scale(0.95);
        }

        .quick-btn span {
            font-size: 12px;
            margin-top: 5px;
        }

        .btn-smile { background: #ffd93d; }
        .btn-cry { background: #6bcf7f; }
        .btn-eye { background: #4ecdc4; }
        .btn-talk { background: #a8e6cf; }
        .btn-interact { background: #ffd3b6; }
        .btn-motor { background: #ffaaa5; }
        .btn-selfcare { background: #d4a5a5; }
        .btn-concern { background: #ff8b94; }

        /* æ¸¸æˆå¡ç‰‡ */
        .game-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .game-card h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .game-card .info {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .game-card .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }

        .game-card .tag {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }

        /* å®æ—¶å¼•å¯¼ */
        .guidance-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .guidance-box h4 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .guidance-box p {
            color: #555;
            line-height: 1.6;
            font-size: 14px;
        }

        /* è®¡æ—¶å™¨ */
        .timer {
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
            font-family: monospace;
        }

        /* è¿›åº¦æ¡ */
        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        /* åé¦ˆè¡¨ */
        .feedback-question {
            margin-bottom: 20px;
        }

        .feedback-question h4 {
            font-size: 14px;
            color: #333;
            margin-bottom: 10px;
        }

        .rating-options {
            display: flex;
            gap: 10px;
        }

        .rating-option {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rating-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        /* åº•éƒ¨å¯¼èˆª */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            padding: 8px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 8px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
        }

        .nav-item.active {
            color: #667eea;
        }

        .nav-item .icon {
            font-size: 24px;
        }

        .nav-item .label {
            font-size: 11px;
            margin-top: 2px;
        }

        /* æç¤ºä¿¡æ¯ */
        .toast {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 2000;
            display: none;
        }

        .toast.show {
            display: block;
        }

        /* éšè—ç±» */
        .hidden {
            display: none !important;
        }

        /* å¾½ç«  */
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-primary {
            background: #cce5ff;
            color: #004085;
        }

        /* ç”»åƒå±•ç¤º */
        .profile-section {
            margin-bottom: 15px;
        }

        .profile-section h4 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag-item {
            background: #f0f4ff;
            color: #667eea;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
        }

        /* è§‚å¯Ÿè®°å½•åˆ—è¡¨ */
        .observation-item {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 3px solid #667eea;
        }

        .observation-item .time {
            font-size: 12px;
            color: #999;
            margin-bottom: 5px;
        }

        .observation-item .content {
            font-size: 14px;
            color: #333;
        }

        /* è®°å½•æŒ‰é’® */
        .record-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            z-index: 1000;
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1500;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-header h3 {
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="header">
        <h1>ğŸ§© ASDåœ°æ¿æ—¶å…‰å¹²é¢„ç³»ç»Ÿ</h1>
        <div class="user-info" id="headerUserInfo">
            <button onclick="showTokenModal()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-size: 12px;">
                ğŸ”‘ è®¾ç½®Token
            </button>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <!-- 1. è¯„ä¼°é¡µé¢ -->
        <div id="page-assessment" class="page active">
            <div class="card">
                <div class="card-title">
                    <span class="icon">ğŸ“‹</span>
                    åˆ›å»ºå­©å­ç”»åƒ
                </div>
                <div class="form-group">
                    <label>å­©å­å§“å *</label>
                    <input type="text" id="childName" placeholder="è¯·è¾“å…¥å­©å­å§“å" value="è¾°è¾°">
                </div>
                <div class="form-group">
                    <label>å‡ºç”Ÿæ—¥æœŸ *</label>
                    <input type="date" id="birthDate" value="2021-07-15">
                </div>
                <div class="form-group">
                    <label>æ€§åˆ«</label>
                    <select id="gender">
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="male">ç”·</option>
                        <option value="female">å¥³</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è¯Šæ–­ç»“æœ</label>
                    <input type="text" id="diagnosis" placeholder="å¦‚: ASDè½»åº¦" value="ASDè½»åº¦">
                </div>
                <div class="form-group">
                    <label>è¯„ä¼°æŠ¥å‘Šå†…å®¹ *</label>
                    <textarea id="assessmentData" placeholder="è¯·è¾“å…¥è¯„ä¼°æŠ¥å‘Šæˆ–åŒ»é™¢è¯Šæ–­å†…å®¹">CARS-2è¯„åˆ†ï¼š35åˆ†ï¼ˆè½»åº¦-ä¸­åº¦ï¼‰

è¡Œä¸ºè§‚å¯Ÿï¼š
- çœ¼ç¥æ¥è§¦ï¼šå¶å°”æœ‰è¢«åŠ¨çœ¼ç¥æ¥è§¦ï¼Œä¸»åŠ¨å°‘
- è¯­è¨€å‘è‚²ï¼šå•å­—è¡¨è¾¾ï¼Œä¸ä¼šè¯´çŸ­è¯­
- ç¤¾äº¤äº’åŠ¨ï¼šå¯¹åŒé¾„äººä¸æ„Ÿå…´è¶£ï¼Œæ›´å–œæ¬¢ç‹¬è‡ªç©è€
- åˆ»æ¿è¡Œä¸ºï¼šå–œæ¬¢æ—‹è½¬è½¦è½®ã€å¼€å…³é—¨
- æ„Ÿå®˜ååº”ï¼šå¯¹å£°éŸ³æ•æ„Ÿï¼Œç‰¹åˆ«å–œæ¬¢æµæ°´å£°

å®¶é•¿æè¿°ï¼š
å­©å­å¯¹ç§¯æœ¨æœ‰ç‚¹å…´è¶£ï¼Œä½†ä¸ä¼šç©ã€‚æ´—æ¾¡æ—¶ç‰¹åˆ«å–œæ¬¢ç©æ°´ï¼Œå¯ä»¥ç›¯ç€æ°´é¾™å¤´çœ‹å¾ˆä¹…ã€‚</textarea>
                </div>
                <div class="form-group">
                    <label>å…¶ä»–å¤‡æ³¨</label>
                    <textarea id="notes" placeholder="å…¶ä»–è§‚å¯Ÿæˆ–å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰">å­©å­å¯¹ç§¯æœ¨å’Œæ°´æµæœ‰å…´è¶£</textarea>
                </div>
                <button class="btn" onclick="importAssessment()">ç”Ÿæˆå­©å­ç”»åƒ</button>
            </div>
        </div>

        <!-- 2. æ¸¸æˆæ¨èé¡µé¢ -->
        <div id="page-recommendations" class="page">
            <div class="card">
                <div class="card-title">
                    <span class="icon">ğŸ®</span>
                    æ¨èçš„åœ°æ¿æ¸¸æˆ
                </div>
                <div id="recommendationsList">
                    <p style="color: #999; text-align: center; padding: 20px;">è¯·å…ˆå®Œæˆè¯„ä¼°</p>
                </div>
            </div>
        </div>

        <!-- 3. æ¸¸æˆå®æ–½é¡µé¢ -->
        <div id="page-session" class="page">
            <div class="card">
                <div class="card-title">
                    <span class="icon">ğŸ¯</span>
                    <span id="sessionGameTitle">é€‰æ‹©æ¸¸æˆå¼€å§‹</span>
                </div>
                <div id="sessionContent">
                    <p style="color: #999; text-align: center; padding: 20px;">è¯·å…ˆä»æ¨èé¡µé¢é€‰æ‹©æ¸¸æˆ</p>
                </div>
            </div>
        </div>

        <!-- 4. åé¦ˆé¡µé¢ -->
        <div id="page-feedback" class="page">
            <div class="card">
                <div class="card-title">
                    <span class="icon">ğŸ“</span>
                    æœ¬æ¬¡æ¸¸æˆåé¦ˆ
                </div>
                <div id="feedbackContent">
                    <p style="color: #999; text-align: center; padding: 20px;">è¯·å…ˆå®Œæˆæ¸¸æˆå®æ–½</p>
                </div>
            </div>
        </div>

        <!-- 5. æˆé•¿è®°å½•é¡µé¢ -->
        <div id="page-progress" class="page">
            <div class="card">
                <div class="card-title">
                    <span class="icon">ğŸ“Š</span>
                    å­©å­æˆé•¿æ¡£æ¡ˆ
                </div>
                <div id="progressContent">
                    <p style="color: #999; text-align: center; padding: 20px;">åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- å¿«æ·è®°å½•æŒ‰é’® -->
    <button class="record-btn" onclick="showRecordModal()">+</button>

    <!-- è®°å½•æ¨¡æ€æ¡† -->
    <div id="recordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“ éšæ—¶è®°å½•</h3>
                <button class="modal-close" onclick="closeRecordModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>è®°å½•æ–¹å¼</label>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button class="btn btn-outline" onclick="switchRecordType('text')" style="flex: 1;">æ–‡å­—è®°å½•</button>
                    <button class="btn btn-outline" onclick="switchRecordType('voice')" style="flex: 1;">è¯­éŸ³è®°å½•</button>
                </div>
            </div>
            <div id="recordTypeText">
                <div class="form-group">
                    <label>è§‚å¯Ÿåˆ°çš„æƒ…å†µ</label>
                    <textarea id="quickRecordText" placeholder="æè¿°å­©å­çš„è¡Œä¸ºã€æƒ…ç»ªã€è¿›æ­¥ç­‰..."></textarea>
                </div>
            </div>
            <div id="recordTypeVoice" class="hidden">
                <div class="form-group">
                    <label>è¯­éŸ³è®°å½•</label>
                    <button class="btn" id="voiceRecordBtn" onclick="toggleVoiceRecord()">ğŸ¤ æŒ‰ä½è¯´è¯</button>
                    <p id="voiceStatus" style="text-align: center; color: #666; margin-top: 10px;"></p>
                </div>
            </div>
            <button class="btn" onclick="submitQuickRecord()">æäº¤è®°å½•</button>
        </div>
    </div>

    <!-- Tokenè®¾ç½®æ¨¡æ€æ¡† -->
    <div id="tokenModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ”‘ è®¾ç½®è®¿é—®Token</h3>
                <button class="modal-close" onclick="closeTokenModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>è®¿é—®Token</label>
                <textarea id="tokenInput" placeholder="è¯·ç²˜è´´ä½ çš„è®¿é—®Token..." style="min-height: 100px; font-family: monospace; font-size: 12px;"></textarea>
                <p style="font-size: 12px; color: #999; margin-top: 5px;">
                    ğŸ’¡ æç¤ºï¼šè¯·å…ˆä½¿ç”¨ hhctest.html ç™»å½•è·å–Tokenï¼Œç„¶åç²˜è´´åˆ°è¿™é‡Œ
                </p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="saveToken()" style="flex: 1;">ä¿å­˜Token</button>
                <button class="btn btn-secondary" onclick="clearTokenData()" style="flex: 1;">æ¸…é™¤Token</button>
            </div>
            <div id="tokenStatus" style="margin-top: 15px; padding: 10px; border-radius: 8px; display: none;"></div>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('assessment')">
            <div class="icon">ğŸ“‹</div>
            <div class="label">è¯„ä¼°</div>
        </div>
        <div class="nav-item" onclick="switchPage('recommendations')">
            <div class="icon">ğŸ®</div>
            <div class="label">æ¸¸æˆ</div>
        </div>
        <div class="nav-item" onclick="switchPage('session')">
            <div class="icon">ğŸ¯</div>
            <div class="label">å®æ–½</div>
        </div>
        <div class="nav-item" onclick="switchPage('feedback')">
            <div class="icon">ğŸ’¬</div>
            <div class="label">åé¦ˆ</div>
        </div>
        <div class="nav-item" onclick="switchPage('progress')">
            <div class="icon">ğŸ“Š</div>
            <div class="label">æˆé•¿</div>
        </div>
    </div>

    <!-- Toastæç¤º -->
    <div id="toast" class="toast"></div>

    <script>
        const API_BASE = 'http://localhost:5001';
        let currentToken = localStorage.getItem('token') || null;
        let currentUser = JSON.parse(localStorage.getItem('user') || 'null');
        let currentChild = JSON.parse(localStorage.getItem('currentChild') || 'null');
        let currentGame = JSON.parse(localStorage.getItem('currentGame') || 'null');
        let currentSession = JSON.parse(localStorage.getItem('currentSession') || 'null');
        let sessionTimer = null;
        let sessionSeconds = 0;
        let sessionObservations = [];
        let isRecording = false;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            if (currentChild) {
                loadRecommendations();
                loadProgress();
            }
        });

        // æ˜¾ç¤ºToast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        function checkAuth() {
            if (currentToken) {
                document.getElementById('headerUserInfo').innerHTML = `
                    <span style="margin-right: 10px;">âœ… Tokenå·²è®¾ç½®</span>
                    <button onclick="showTokenModal()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-size: 12px;">
                        ğŸ”‘ ç®¡ç†Token
                    </button>
                `;
            } else {
                document.getElementById('headerUserInfo').innerHTML = `
                    <button onclick="showTokenModal()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 5px 15px; border-radius: 15px; cursor: pointer; font-size: 12px;">
                        ğŸ”‘ è®¾ç½®Token
                    </button>
                `;
                showToast('âš ï¸ è¯·å…ˆè®¾ç½®Tokenæ‰èƒ½ä½¿ç”¨ç³»ç»Ÿ');
            }
        }

        // æ˜¾ç¤ºTokenæ¨¡æ€æ¡†
        function showTokenModal() {
            document.getElementById('tokenModal').classList.add('show');
            if (currentToken) {
                document.getElementById('tokenInput').value = currentToken;
            }
        }

        // å…³é—­Tokenæ¨¡æ€æ¡†
        function closeTokenModal() {
            document.getElementById('tokenModal').classList.remove('show');
        }

        // ä¿å­˜Token
        function saveToken() {
            const token = document.getElementById('tokenInput').value.trim();
            if (!token) {
                showToast('âŒ è¯·è¾“å…¥Token');
                return;
            }

            currentToken = token;
            localStorage.setItem('token', currentToken);
            
            const statusDiv = document.getElementById('tokenStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#d4edda';
            statusDiv.style.color = '#155724';
            statusDiv.innerHTML = 'âœ… Tokenå·²ä¿å­˜ï¼å¯ä»¥å¼€å§‹ä½¿ç”¨ç³»ç»Ÿäº†';
            
            checkAuth();
            showToast('âœ… Tokenè®¾ç½®æˆåŠŸ');
            
            setTimeout(() => {
                closeTokenModal();
                statusDiv.style.display = 'none';
            }, 2000);
        }

        // æ¸…é™¤Tokenæ•°æ®
        function clearTokenData() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤Tokenå—ï¼Ÿæ¸…é™¤åéœ€è¦é‡æ–°è®¾ç½®ã€‚')) {
                currentToken = null;
                currentUser = null;
                currentChild = null;
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                localStorage.removeItem('currentChild');
                
                document.getElementById('tokenInput').value = '';
                
                const statusDiv = document.getElementById('tokenStatus');
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
                statusDiv.innerHTML = 'âš ï¸ Tokenå·²æ¸…é™¤';
                
                checkAuth();
                showToast('Tokenå·²æ¸…é™¤');
                
                setTimeout(() => {
                    closeTokenModal();
                    statusDiv.style.display = 'none';
                }, 2000);
            }
        }

        // åˆ‡æ¢é¡µé¢
        function switchPage(page) {
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            document.getElementById(`page-${page}`).classList.add('active');

            // æ›´æ–°å¯¼èˆªçŠ¶æ€
            const navItems = document.querySelectorAll('.nav-item');
            const pageIndex = { assessment: 0, recommendations: 1, session: 2, feedback: 3, progress: 4 };
            navItems[pageIndex[page]].classList.add('active');

            // é¡µé¢ç‰¹å®šåŠ è½½
            if (page === 'recommendations' && currentChild) {
                loadRecommendations();
            } else if (page === 'progress') {
                loadProgress();
            }
        }

        // 1. å¯¼å…¥è¯„ä¼°å¹¶ç”Ÿæˆç”»åƒ
        async function importAssessment() {
            const childName = document.getElementById('childName').value;
            const birthDate = document.getElementById('birthDate').value;
            const gender = document.getElementById('gender').value;
            const diagnosis = document.getElementById('diagnosis').value;
            const assessmentData = document.getElementById('assessmentData').value;
            const notes = document.getElementById('notes').value;

            if (!childName || !assessmentData) {
                showToast('è¯·è¾“å…¥å­©å­å§“åå’Œè¯„ä¼°æŠ¥å‘Š');
                return;
            }

            showToast('æ­£åœ¨AIåˆ†æè¯„ä¼°æŠ¥å‘Š...');

            try {
                const response = await fetch(`${API_BASE}/api/assessments/import`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({
                        assessmentData,
                        childInfo: { name: childName, birthDate, gender, diagnosis, notes }
                    })
                });

                const data = await response.json();

                if (data.success) {
                    currentChild = data.data.childProfile;
                    localStorage.setItem('currentChild', JSON.stringify(currentChild));
                    showToast('âœ… å­©å­ç”»åƒç”ŸæˆæˆåŠŸï¼');
                    switchPage('recommendations');
                } else {
                    showToast('âŒ ' + data.message);
                }
            } catch (error) {
                showToast('âŒ è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        // 2. åŠ è½½æ¸¸æˆæ¨è
        async function loadRecommendations() {
            if (!currentChild) {
                document.getElementById('recommendationsList').innerHTML =
                    '<p style="color: #999; text-align: center; padding: 20px;">è¯·å…ˆå®Œæˆè¯„ä¼°</p>';
                return;
            }

            showToast('æ­£åœ¨AIæ¨èæ¸¸æˆ...');

            // æ¨¡æ‹Ÿæ¸¸æˆæ¨èï¼ˆå®é™…åº”è¯¥è°ƒç”¨åç«¯APIï¼‰
            const games = [
                {
                    id: 'game_001',
                    name: 'ç§¯æœ¨ä¼ é€’æ¸¸æˆ',
                    description: 'é€šè¿‡ä¼ é€’ç§¯æœ¨å»ºç«‹åŒå‘æ²Ÿé€šï¼ŒåŸ¹å…»çœ¼ç¥æ¥è§¦å’Œäº’åŠ¨æ„è¯†',
                    targetGoals: ['å»ºç«‹çœ¼ç¥æ¥è§¦', 'å‘å±•åŒå‘æ²Ÿé€š', 'åŸ¹å…»äº’åŠ¨æ„è¯†'],
                    duration: '15åˆ†é’Ÿ',
                    difficulty: 'åˆçº§'
                },
                {
                    id: 'game_002',
                    name: 'èº²çŒ«çŒ«æ¸¸æˆ',
                    description: 'åˆ©ç”¨å­©å­å¯¹æ¶ˆå¤±-å‡ºç°çš„å…´è¶£ï¼Œå¼•å¯¼ä¸»åŠ¨å‚ä¸å’Œæƒ…ç»ªè¡¨è¾¾',
                    targetGoals: ['æ¿€å‘æƒ…ç»ªè¡¨è¾¾', 'å»ºç«‹äº²å¯†å…³ç³»', 'åŸ¹å…»å…±åŒæ³¨æ„'],
                    duration: '10åˆ†é’Ÿ',
                    difficulty: 'å…¥é—¨'
                },
                {
                    id: 'game_003',
                    name: 'æ°´ä¸Šæ¼‚æµæ¸¸æˆ',
                    description: 'åˆ©ç”¨å­©å­å¯¹æ°´æµçš„å…´è¶£ï¼ŒåŸ¹å…»å…±åŒæ³¨æ„åŠ›å’Œè§‚å¯ŸåŠ›',
                    targetGoals: ['åŸ¹å…»å…±åŒæ³¨æ„', 'ä¿ƒè¿›æ„Ÿå®˜æ¢ç´¢', 'å‘å±•åŒå‘æ²Ÿé€š'],
                    duration: '20åˆ†é’Ÿ',
                    difficulty: 'åˆçº§'
                }
            ];

            let html = '';
            games.forEach(game => {
                html += `
                    <div class="game-card">
                        <h3>${game.name}</h3>
                        <p class="info">${game.description}</p>
                        <div class="tags">
                            <span class="tag">â±ï¸ ${game.duration}</span>
                            <span class="tag">ğŸ“Š ${game.difficulty}</span>
                        </div>
                        <div class="tags">
                            ${game.targetGoals.map(goal => `<span class="tag">ğŸ¯ ${goal}</span>`).join('')}
                        </div>
                        <button class="btn" style="background: white; color: #667eea;" onclick="startGame('${game.id}', '${game.name}')">å¼€å§‹è¿™ä¸ªæ¸¸æˆ</button>
                    </div>
                `;
            });

            document.getElementById('recommendationsList').innerHTML = html;
        }

        // 3. å¼€å§‹æ¸¸æˆ
        function startGame(gameId, gameName) {
            currentGame = { id: gameId, name: gameName };
            localStorage.setItem('currentGame', JSON.stringify(currentGame));
            currentSession = {
                gameId,
                startTime: new Date().toISOString(),
                observations: []
            };
            localStorage.setItem('currentSession', JSON.stringify(currentSession));

            switchPage('session');
            setupSessionUI();
        }

        // è®¾ç½®æ¸¸æˆå®æ–½ç•Œé¢
        function setupSessionUI() {
            if (!currentGame) return;

            document.getElementById('sessionGameTitle').textContent = currentGame.name;

            const html = `
                <div class="guidance-box">
                    <h4>ğŸ’¡ æ¸¸æˆæŒ‡å¼•</h4>
                    <p><strong>ç›®æ ‡ï¼š</strong>å»ºç«‹æƒ…æ„Ÿè”ç»“ï¼ŒåŸ¹å…»çœ¼ç¥æ¥è§¦å’ŒåŒå‘æ²Ÿé€š</p>
                    <p><strong>æ­¥éª¤ï¼š</strong></p>
                    <ol style="margin-left: 20px; margin-top: 10px;">
                        <li>ååœ¨å­©å­é¢å‰ï¼Œä¸ä»–å¹³è§†</li>
                        <li>æ‹¿ä¸€å—ç§¯æœ¨é€’ç»™å­©å­</li>
                        <li>ç­‰å¾…å­©å­çš„ååº”ï¼ˆé‡è¦ï¼šä¸è¦å‚¬ä¿ƒï¼‰</li>
                        <li>å¦‚æœå­©å­æ¥è¿‡ï¼Œå¾®ç¬‘å›åº”</li>
                        <li>é¼“åŠ±å­©å­æŠŠç§¯æœ¨é€’å›æ¥</li>
                        <li>é‡å¤è¿™ä¸ªè¿‡ç¨‹ï¼Œä¿æŒè€å¿ƒ</li>
                    </ol>
                    <p style="margin-top: 10px;"><strong>æç¤ºï¼š</strong>è·Ÿéšå­©å­çš„èŠ‚å¥ï¼Œå¦‚æœä»–æ²¡å…´è¶£å°±æ¢å…¶ä»–ç©å…·ã€‚</p>
                </div>

                <div class="timer" id="sessionTimer">00:00</div>

                <div class="card-title" style="margin-bottom: 15px;">
                    <span class="icon">âš¡</span>
                    å¿«æ·è®°å½•ï¼ˆå®æ—¶è§‚å¯Ÿï¼‰
                </div>
                <div class="quick-record-buttons">
                    <button class="quick-btn btn-smile" onclick="quickRecord('smile', 'ğŸ˜Š')">å¾®ç¬‘</button>
                    <button class="quick-btn btn-eye" onclick="quickRecord('eye', 'ğŸ‘€')">çœ¼ç¥</button>
                    <button class="quick-btn btn-talk" onclick="quickRecord('talk', 'ğŸ—£ï¸')">å‡ºå£°</button>
                    <button class="quick-btn btn-interact" onclick="quickRecord('interact', 'ğŸ¤')">äº’åŠ¨</button>
                    <button class="quick-btn btn-motor" onclick="quickRecord('motor', 'âœ‹')">åŠ¨ä½œ</button>
                    <button class="quick-btn btn-concern" onclick="quickRecord('concern', 'â“')">å…³æ³¨</button>
                </div>

                <div id="observationsList"></div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="pauseSession()">â¸ï¸ æš‚åœ</button>
                    <button class="btn" onclick="endSession()">â¹ï¸ ç»“æŸæ¸¸æˆ</button>
                </div>
            `;

            document.getElementById('sessionContent').innerHTML = html;
            startSessionTimer();
        }

        // ä¼šè¯è®¡æ—¶å™¨
        function startSessionTimer() {
            sessionSeconds = 0;
            sessionTimer = setInterval(() => {
                sessionSeconds++;
                const minutes = Math.floor(sessionSeconds / 60).toString().padStart(2, '0');
                const seconds = (sessionSeconds % 60).toString().padStart(2, '0');
                document.getElementById('sessionTimer').textContent = `${minutes}:${seconds}`;
            }, 1000);
        }

        // å¿«æ·è®°å½•
        function quickRecord(type, emoji) {
            const labels = {
                smile: 'å¾®ç¬‘',
                eye: 'çœ¼ç¥æ¥è§¦',
                talk: 'å‘å£°/è¯´è¯',
                interact: 'ä¸»åŠ¨äº’åŠ¨',
                motor: 'å¤§åŠ¨ä½œ/ç²¾ç»†åŠ¨ä½œ',
                concern: 'éœ€è¦å…³æ³¨çš„è¡Œä¸º'
            };

            const observation = {
                time: new Date().toISOString(),
                type,
                emoji,
                label: labels[type],
                timestamp: formatTime(new Date())
            };

            sessionObservations.push(observation);
            currentSession.observations = sessionObservations;
            localStorage.setItem('currentSession', JSON.stringify(currentSession));

            // æ˜¾ç¤ºè®°å½•
            addObservationToList(observation);
            showToast(`âœ… å·²è®°å½•ï¼š${emoji} ${labels[type]}`);
        }

        // æ·»åŠ è§‚å¯Ÿè®°å½•åˆ°åˆ—è¡¨
        function addObservationToList(observation) {
            const list = document.getElementById('observationsList');
            const item = document.createElement('div');
            item.className = 'observation-item';
            item.innerHTML = `
                <div class="time">${observation.timestamp}</div>
                <div class="content">${observation.emoji} ${observation.label}</div>
            `;
            list.insertBefore(item, list.firstChild);
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(date) {
            return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        // æš‚åœä¼šè¯
        function pauseSession() {
            showToast('â¸ï¸ ä¼šè¯å·²æš‚åœ');
            clearInterval(sessionTimer);
        }

        // ç»“æŸä¼šè¯
        function endSession() {
            if (!confirm('ç¡®å®šè¦ç»“æŸè¿™æ¬¡æ¸¸æˆå—ï¼Ÿ')) return;

            clearInterval(sessionTimer);
            currentSession.endTime = new Date().toISOString();
            currentSession.duration = sessionSeconds;
            localStorage.setItem('currentSession', JSON.stringify(currentSession));

            showToast('âœ… æ¸¸æˆå·²ç»“æŸ');
            switchPage('feedback');
            setupFeedbackUI();
        }

        // 4. è®¾ç½®åé¦ˆç•Œé¢
        function setupFeedbackUI() {
            const minutes = Math.floor(sessionSeconds / 60);
            const obsCount = sessionObservations.length;

            const html = `
                <div class="guidance-box" style="background: #fff3cd; border-left-color: #ffc107;">
                    <h4>ğŸ“Š æœ¬æ¬¡æ¸¸æˆæ€»ç»“</h4>
                    <p><strong>æ—¶é•¿ï¼š</strong>${minutes}åˆ†é’Ÿ</p>
                    <p><strong>è§‚å¯Ÿè®°å½•ï¼š</strong>${obsCount}æ¡</p>
                    <p><strong>äº®ç‚¹ï¼š</strong>æ ¹æ®è®°å½•ï¼Œå­©å­åœ¨æœ¬æ¬¡æ¸¸æˆä¸­è¡¨ç°è‰¯å¥½</p>
                </div>

                <div class="feedback-question">
                    <h4>1. ä»Šå¤©å­©å­çš„çœ¼ç¥æ¥è§¦æ¯”å¹³æ—¶å¤šå—ï¼Ÿ</h4>
                    <div class="rating-options" id="q1">
                        <div class="rating-option" onclick="selectRating('q1', 1)">1<br>å¾ˆå°‘</div>
                        <div class="rating-option" onclick="selectRating('q1', 2)">2<br>è¾ƒå°‘</div>
                        <div class="rating-option" onclick="selectRating('q1', 3)">3<br>ä¸€èˆ¬</div>
                        <div class="rating-option" onclick="selectRating('q1', 4)">4<br>è¾ƒå¤š</div>
                        <div class="rating-option" onclick="selectRating('q1', 5)">5<br>å¾ˆå¤š</div>
                    </div>
                </div>

                <div class="feedback-question">
                    <h4>2. å­©å­ä»Šå¤©çš„æƒ…ç»ªçŠ¶æ€æ€ä¹ˆæ ·ï¼Ÿ</h4>
                    <div class="rating-options" id="q2">
                        <div class="rating-option" onclick="selectRating('q2', 1)">1<br>å¾ˆå·®</div>
                        <div class="rating-option" onclick="selectRating('q2', 2)">2<br>è¾ƒå·®</div>
                        <div class="rating-option" onclick="selectRating('q2', 3)">3<br>ä¸€èˆ¬</div>
                        <div class="rating-option" onclick="selectRating('q2', 4)">4<br>è¾ƒå¥½</div>
                        <div class="rating-option" onclick="selectRating('q2', 5)">5<br>å¾ˆå¥½</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>3. ä»Šå¤©æœ€è®©ä½ å°è±¡æ·±åˆ»çš„æ—¶åˆ»æ˜¯ä»€ä¹ˆï¼Ÿ</label>
                    <textarea id="feedbackMoment" placeholder="æè¿°ä»Šå¤©çš„äº®ç‚¹æˆ–çªç ´..."></textarea>
                </div>

                <div class="form-group">
                    <label>4. ä½ è§‰å¾—ä»Šå¤©çš„æ¸¸æˆæ—¶é•¿åˆé€‚å—ï¼Ÿ</label>
                    <select id="feedbackDuration">
                        <option value="">è¯·é€‰æ‹©</option>
                        <option value="too-short">å¤ªçŸ­äº†</option>
                        <option value="just-right" selected>åˆšåˆšå¥½</option>
                        <option value="too-long">å¤ªé•¿äº†</option>
                    </select>
                </div>

                <button class="btn" onclick="submitFeedback()">æäº¤åé¦ˆå¹¶å®Œæˆé—­ç¯</button>
            `;

            document.getElementById('feedbackContent').innerHTML = html;
        }

        // é€‰æ‹©è¯„åˆ†
        function selectRating(questionId, value) {
            const container = document.getElementById(questionId);
            container.querySelectorAll('.rating-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.textContent.includes(value.toString())) {
                    opt.classList.add('selected');
                }
            });
            container.dataset.value = value;
        }

        // æäº¤åé¦ˆ
        async function submitFeedback() {
            const feedback = {
                q1: document.getElementById('q1').dataset.value,
                q2: document.getElementById('q2').dataset.value,
                moment: document.getElementById('feedbackMoment').value,
                duration: document.getElementById('feedbackDuration').value
            };

            if (!feedback.q1 || !feedback.q2) {
                showToast('è¯·å®Œæˆè¯„åˆ†é—®é¢˜');
                return;
            }

            showToast('ğŸ”„ æ­£åœ¨åˆ†æå¹¶æ›´æ–°å­©å­ç”»åƒ...');

            // æ¨¡æ‹ŸAIåˆ†æå’Œæ›´æ–°ç”»åƒ
            setTimeout(() => {
                showToast('âœ… åé¦ˆå·²æäº¤ï¼å­©å­ç”»åƒå·²æ›´æ–°');

                // æ¸…é™¤å½“å‰ä¼šè¯
                currentSession = null;
                currentGame = null;
                sessionObservations = [];
                localStorage.removeItem('currentSession');
                localStorage.removeItem('currentGame');

                // åˆ‡æ¢åˆ°æˆé•¿é¡µé¢æŸ¥çœ‹æ›´æ–°
                setTimeout(() => {
                    switchPage('progress');
                }, 1500);
            }, 2000);
        }

        // 5. åŠ è½½æˆé•¿è®°å½•
        function loadProgress() {
            if (!currentChild) {
                document.getElementById('progressContent').innerHTML =
                    '<p style="color: #999; text-align: center; padding: 20px;">è¯·å…ˆå®Œæˆè¯„ä¼°</p>';
                return;
            }

            const html = `
                <div class="profile-section">
                    <h4>ğŸ‘¶ å­©å­ä¿¡æ¯</h4>
                    <p><strong>å§“åï¼š</strong>${currentChild.name || 'è¾°è¾°'}</p>
                    <p><strong>å¹´é¾„ï¼š</strong>${calculateAge(currentChild.birth_date)}</p>
                    <p><strong>è¯Šæ–­ï¼š</strong>${currentChild.diagnosis || 'æœªå¡«å†™'}</p>
                </div>

                <div class="profile-section">
                    <h4>ğŸ’ª ä¼˜åŠ¿èƒ½åŠ›</h4>
                    <div class="tag-list">
                        <span class="tag-item">è®°å¿†åŠ›å¥½</span>
                        <span class="tag-item">å¯¹å£°éŸ³æ•æ„Ÿ</span>
                        <span class="tag-item">ä¸“æ³¨åŠ›å¼º</span>
                    </div>
                </div>

                <div class="profile-section">
                    <h4>ğŸ¯ å¹²é¢„é‡ç‚¹</h4>
                    <div class="tag-list">
                        <span class="tag-item">çœ¼ç¥æ¥è§¦</span>
                        <span class="tag-item">åŒå‘æ²Ÿé€š</span>
                        <span class="tag-item">æƒ…ç»ªè¡¨è¾¾</span>
                    </div>
                </div>

                <div class="profile-section">
                    <h4>ğŸ“ˆ æœ€è¿‘è¿›å±•</h4>
                    <div class="progress-bar">
                        <div class="fill" style="width: 65%;"></div>
                    </div>
                    <p style="font-size: 14px; color: #666; margin-top: 8px;">
                        çœ¼ç¥æ¥è§¦ï¼šè¿›æ­¥ 65% â¬†ï¸<br>
                        åŒå‘æ²Ÿé€šï¼šè¿›æ­¥ 40% â¬†ï¸<br>
                        æƒ…ç»ªè¡¨è¾¾ï¼šè¿›æ­¥ 25% â¬†ï¸
                    </p>
                </div>

                <div class="profile-section">
                    <h4>ğŸŒŸ é‡è¦é‡Œç¨‹ç¢‘</h4>
                    <div class="observation-item">
                        <div class="time">2024-01-23 14:30</div>
                        <div class="content">ğŸ‰ é¦–æ¬¡ä¸»åŠ¨é€’ç§¯æœ¨ - çªç ´æ€§è¿›å±•ï¼</div>
                    </div>
                    <div class="observation-item">
                        <div class="time">2024-01-20 10:15</div>
                        <div class="content">ğŸ‘€ çœ¼ç¥æ¥è§¦è¾¾åˆ°3ç§’ - è¿›æ­¥æ˜æ˜¾ï¼</div>
                    </div>
                </div>

                <div class="profile-section">
                    <h4>ğŸ“Š å¹²é¢„å†å²</h4>
                    <p style="font-size: 14px; color: #666;">
                        ç´¯è®¡æ¸¸æˆæ¬¡æ•°ï¼š12æ¬¡<br>
                        æ€»æ¸¸æˆæ—¶é•¿ï¼š180åˆ†é’Ÿ<br>
                        è§‚å¯Ÿè®°å½•ï¼š45æ¡
                    </p>
                </div>
            `;

            document.getElementById('progressContent').innerHTML = html;
        }

        // è®¡ç®—å¹´é¾„
        function calculateAge(birthDate) {
            if (!birthDate) return 'æœªçŸ¥';
            const birth = new Date(birthDate);
            const today = new Date();
            const years = today.getFullYear() - birth.getFullYear();
            const months = today.getMonth() - birth.getMonth();
            return `${years}å²${months > 0 ? months + 'ä¸ªæœˆ' : ''}`;
        }

        // å¿«é€Ÿè®°å½•æ¨¡æ€æ¡†
        function showRecordModal() {
            document.getElementById('recordModal').classList.add('show');
        }

        function closeRecordModal() {
            document.getElementById('recordModal').classList.remove('show');
        }

        function switchRecordType(type) {
            if (type === 'text') {
                document.getElementById('recordTypeText').classList.remove('hidden');
                document.getElementById('recordTypeVoice').classList.add('hidden');
            } else {
                document.getElementById('recordTypeText').classList.add('hidden');
                document.getElementById('recordTypeVoice').classList.remove('hidden');
            }
        }

        // è¯­éŸ³è®°å½•
        function toggleVoiceRecord() {
            const btn = document.getElementById('voiceRecordBtn');
            const status = document.getElementById('voiceStatus');

            if (!isRecording) {
                isRecording = true;
                btn.textContent = 'â¹ï¸ åœæ­¢';
                btn.style.background = '#ff6b6b';
                status.textContent = 'ğŸ¤ æ­£åœ¨å½•éŸ³...';
            } else {
                isRecording = false;
                btn.textContent = 'ğŸ¤ æŒ‰ä½è¯´è¯';
                btn.style.background = '';
                status.textContent = 'âœ… å½•éŸ³å®Œæˆï¼ˆæ¨¡æ‹Ÿï¼‰';
            }
        }

        // æäº¤å¿«é€Ÿè®°å½•
        async function submitQuickRecord() {
            const text = document.getElementById('quickRecordText').value;

            if (!text) {
                showToast('è¯·è¾“å…¥è®°å½•å†…å®¹');
                return;
            }

            showToast('âœ… è®°å½•å·²ä¿å­˜');
            document.getElementById('quickRecordText').value = '';
            closeRecordModal();

            // è¿™é‡Œåº”è¯¥è°ƒç”¨åç«¯APIä¿å­˜è®°å½•
        }
    </script>
</body>
</html>
