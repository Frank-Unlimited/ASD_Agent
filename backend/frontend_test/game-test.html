<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆåŠŸèƒ½æµ‹è¯• - ASDåœ°æ¿æ—¶å…‰å¹²é¢„ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .result pre {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status.online {
            background: #d4edda;
            color: #155724;
        }

        .status.offline {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ® æ¸¸æˆåŠŸèƒ½æµ‹è¯•</h1>
            <p>æµ‹è¯•æ¸¸æˆæ¨èå’Œç®¡ç†åŠŸèƒ½</p>
        </div>

        <!-- é…ç½®åŒº -->
        <div class="card">
            <h2>âš™ï¸ é…ç½®</h2>
            <div class="form-group">
                <label>API åœ°å€</label>
                <input type="text" id="apiUrl" value="http://localhost:7860" placeholder="http://localhost:7860">
            </div>
            <div class="form-group">
                <label>å­©å­ ID</label>
                <input type="text" id="childId" value="test_child_001" placeholder="test_child_001">
            </div>
            <button class="btn btn-primary" onclick="checkApiStatus()">æ£€æŸ¥ API çŠ¶æ€</button>
            <div id="apiStatus" class="status" style="display: none; margin-top: 15px;"></div>
        </div>

        <!-- æ¸¸æˆæ¨è -->
        <div class="card">
            <h2>ğŸ® æ¸¸æˆæ¨è</h2>
            <p style="color: #666; margin-bottom: 15px;">ä¸ºå­©å­æ¨èä¸ªæ€§åŒ–çš„åœ°æ¿æ—¶å…‰æ¸¸æˆ</p>
            
            <div class="form-group">
                <label>é‡ç‚¹å…³æ³¨ç»´åº¦ï¼ˆå¯é€‰ï¼‰</label>
                <select id="focusDimension">
                    <option value="">-- è‡ªåŠ¨é€‰æ‹© --</option>
                    <option value="eye_contact">çœ¼ç¥æ¥è§¦</option>
                    <option value="joint_attention">å…±åŒæ³¨æ„åŠ›</option>
                    <option value="social_interaction">ç¤¾äº¤äº’åŠ¨</option>
                    <option value="language">è¯­è¨€æ²Ÿé€š</option>
                    <option value="imitation">æ¨¡ä»¿èƒ½åŠ›</option>
                    <option value="emotional_regulation">æƒ…ç»ªè°ƒèŠ‚</option>
                    <option value="play_skills">æ¸¸æˆæŠ€èƒ½</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>æœŸæœ›æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼Œå¯é€‰ï¼‰</label>
                <input type="number" id="duration" placeholder="15" min="5" max="60">
            </div>
            
            <button class="btn btn-primary" onclick="recommendGame()">ğŸ¯ æ¨èæ¸¸æˆ</button>
            <div id="recommendResult" class="result"></div>
        </div>

        <!-- æ¸¸æˆæ—¥å† -->
        <div class="card">
            <h2>ğŸ“… æ¸¸æˆæ—¥å†</h2>
            <p style="color: #666; margin-bottom: 15px;">æŸ¥çœ‹å­©å­çš„æ‰€æœ‰æ¸¸æˆæ–¹æ¡ˆ</p>
            <button class="btn btn-primary" onclick="getGameCalendar()">è·å–æ¸¸æˆæ—¥å†</button>
            <div id="calendarResult" class="result"></div>
        </div>

        <!-- æ¸¸æˆæ€»ç»“ -->
        <div class="card">
            <h2>ğŸ“ æ¸¸æˆæ€»ç»“</h2>
            <p style="color: #666; margin-bottom: 15px;">ä¸ºå·²å®Œæˆçš„æ¸¸æˆä¼šè¯ç”Ÿæˆæ€»ç»“æŠ¥å‘Š</p>
            
            <div class="form-group">
                <label>ä¼šè¯ ID</label>
                <input type="text" id="sessionId" placeholder="session-xxx" value="session-b2c2df4e4f47">
            </div>
            
            <button class="btn btn-primary" onclick="summarizeGame()">ğŸ“Š ç”Ÿæˆæ¸¸æˆæ€»ç»“</button>
            <div id="summarizeResult" class="result"></div>
        </div>

        <!-- API æµ‹è¯• -->
        <div class="card">
            <h2>ğŸ”§ API æµ‹è¯•</h2>
            <p style="color: #666; margin-bottom: 15px;">æµ‹è¯•å„ä¸ª API ç«¯ç‚¹</p>
            <button class="btn btn-primary" onclick="testAllApis()">æµ‹è¯•æ‰€æœ‰ API</button>
            <div id="testResult" class="result"></div>
        </div>

        <!-- æ§åˆ¶å°æ—¥å¿— -->
        <div class="card">
            <h2>ğŸ“‹ æ§åˆ¶å°æ—¥å¿—</h2>
            <p style="color: #666; margin-bottom: 15px;">æŸ¥çœ‹è¯¦ç»†çš„è¯·æ±‚å’Œå“åº”æ—¥å¿—</p>
            <div id="consoleLog" style="background: #f5f5f5; padding: 15px; border-radius: 8px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; white-space: pre-wrap;"></div>
            <button class="btn btn-primary" onclick="clearConsoleLog()" style="margin-top: 10px;">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <script>
        function getApiUrl() {
            return document.getElementById('apiUrl').value;
        }

        function getChildId() {
            return document.getElementById('childId').value;
        }

        function showResult(elementId, success, message, data = null) {
            const element = document.getElementById(elementId);
            element.className = `result ${success ? 'success' : 'error'}`;
            element.style.display = 'block';
            
            let html = message;
            
            if (typeof data === 'string') {
                html = data;
            } else if (data) {
                html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            element.innerHTML = html;
        }

        async function checkApiStatus() {
            const apiUrl = getApiUrl();
            const statusDiv = document.getElementById('apiStatus');
            
            console.log('='.repeat(80));
            console.log('[å‰ç«¯] æ£€æŸ¥ API çŠ¶æ€');
            console.log('[è¾“å…¥] API URL:', apiUrl);
            
            try {
                const response = await fetch(`${apiUrl}/health`, { timeout: 5000 });
                const data = await response.json();
                
                console.log('[è¾“å‡º] Status:', data);
                console.log('='.repeat(80));
                
                if (response.ok && data.status === 'healthy') {
                    statusDiv.className = 'status online';
                    statusDiv.textContent = 'âœ… API åœ¨çº¿';
                    statusDiv.style.display = 'block';
                } else {
                    statusDiv.className = 'status offline';
                    statusDiv.textContent = 'âŒ API å¼‚å¸¸';
                    statusDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('[é”™è¯¯]', error);
                console.log('='.repeat(80));
                statusDiv.className = 'status offline';
                statusDiv.textContent = 'âŒ æ— æ³•è¿æ¥åˆ° API';
                statusDiv.style.display = 'block';
            }
        }

        async function recommendGame() {
            const childId = getChildId();
            const apiUrl = getApiUrl();
            const focusDimension = document.getElementById('focusDimension').value;
            const duration = document.getElementById('duration').value;
            
            console.log('='.repeat(80));
            console.log('[å‰ç«¯] æ¨èæ¸¸æˆ');
            
            const requestData = {
                child_id: childId
            };
            
            if (focusDimension) {
                requestData.focus_dimension = focusDimension;
            }
            
            if (duration) {
                requestData.duration_preference = parseInt(duration);
            }
            
            console.log('[è¾“å…¥] Request:', JSON.stringify(requestData, null, 2));
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const resultDiv = document.getElementById('recommendResult');
            resultDiv.className = 'result';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<strong>â³ æ­£åœ¨ç”Ÿæˆæ¸¸æˆæ–¹æ¡ˆ...</strong><br>è¿™å¯èƒ½éœ€è¦ 10-30 ç§’ï¼Œè¯·è€å¿ƒç­‰å¾…';
            
            try {
                const startTime = Date.now();
                console.log('[è¯·æ±‚] POST', `${apiUrl}/api/game/recommend`);
                
                const response = await fetch(`${apiUrl}/api/game/recommend`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const endTime = Date.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);
                
                console.log('[å“åº”] çŠ¶æ€ç :', response.status);
                console.log('[å“åº”] è€—æ—¶:', duration, 'ç§’');
                
                const data = await response.json();
                console.log('[è¾“å‡º] Response:', JSON.stringify(data, null, 2));
                console.log('='.repeat(80));
                
                if (response.ok) {
                    const gamePlan = data.game_plan || {};
                    
                    let html = `<strong>âœ… æ¸¸æˆæ¨èæˆåŠŸï¼</strong><br>`;
                    html += `<div style="margin-top: 15px; text-align: left;">`;
                    html += `<h3 style="color: #667eea; margin-bottom: 10px;">ğŸ® ${gamePlan.title || 'N/A'}</h3>`;
                    html += `<p><strong>æè¿°ï¼š</strong>${gamePlan.description || 'N/A'}</p>`;
                    html += `<p><strong>ç›®æ ‡ç»´åº¦ï¼š</strong>${gamePlan.target_dimension || 'N/A'}</p>`;
                    html += `<p><strong>é¢„è®¡æ—¶é•¿ï¼š</strong>${gamePlan.estimated_duration || 'N/A'} åˆ†é’Ÿ</p>`;
                    
                    // æ¸¸æˆç›®æ ‡
                    if (gamePlan.goals) {
                        html += `<p><strong>ä¸»è¦ç›®æ ‡ï¼š</strong>${gamePlan.goals.primary_goal || 'N/A'}</p>`;
                        if (gamePlan.goals.secondary_goals && gamePlan.goals.secondary_goals.length > 0) {
                            html += `<p><strong>æ¬¡è¦ç›®æ ‡ï¼š</strong></p><ul>`;
                            gamePlan.goals.secondary_goals.forEach(goal => {
                                html += `<li>${goal}</li>`;
                            });
                            html += `</ul>`;
                        }
                    }
                    
                    // æ¸¸æˆæ­¥éª¤
                    if (gamePlan.steps && gamePlan.steps.length > 0) {
                        html += `<p><strong>æ¸¸æˆæ­¥éª¤ï¼š</strong>ï¼ˆå…± ${gamePlan.steps.length} æ­¥ï¼‰</p>`;
                        html += `<ol>`;
                        gamePlan.steps.slice(0, 3).forEach(step => {
                            html += `<li><strong>${step.title}</strong>: ${step.description.substring(0, 100)}...</li>`;
                        });
                        if (gamePlan.steps.length > 3) {
                            html += `<li>... è¿˜æœ‰ ${gamePlan.steps.length - 3} ä¸ªæ­¥éª¤</li>`;
                        }
                        html += `</ol>`;
                    }
                    
                    // æ‰€éœ€ææ–™
                    if (gamePlan.materials_needed && gamePlan.materials_needed.length > 0) {
                        html += `<p><strong>æ‰€éœ€ææ–™ï¼š</strong></p><ul>`;
                        gamePlan.materials_needed.forEach(material => {
                            html += `<li>${material}</li>`;
                        });
                        html += `</ul>`;
                    }
                    
                    // è®¾è®¡ä¾æ®
                    if (gamePlan.design_rationale) {
                        html += `<p><strong>è®¾è®¡ä¾æ®ï¼š</strong>${gamePlan.design_rationale.substring(0, 200)}...</p>`;
                    }
                    
                    html += `</div>`;
                    html += `<pre style="margin-top: 15px; max-height: 300px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>`;
                    
                    showResult('recommendResult', true, '', html);
                } else {
                    showResult('recommendResult', false, data.detail || 'æ¨èå¤±è´¥', data);
                }
            } catch (error) {
                console.error('[é”™è¯¯]', error);
                console.log('='.repeat(80));
                showResult('recommendResult', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
            }
        }

        async function getGameCalendar() {
            const childId = getChildId();
            const apiUrl = getApiUrl();
            
            console.log('='.repeat(80));
            console.log('[å‰ç«¯] è·å–æ¸¸æˆæ—¥å†');
            console.log('[è¾“å…¥] API URL:', `${apiUrl}/api/game/calendar/${childId}`);
            
            try {
                const response = await fetch(`${apiUrl}/api/game/calendar/${childId}`);
                
                console.log('[å“åº”] çŠ¶æ€ç :', response.status);
                
                const data = await response.json();
                console.log('[è¾“å‡º] Response:', JSON.stringify(data, null, 2));
                console.log('='.repeat(80));
                
                if (response.ok) {
                    showResult('calendarResult', true, 'è·å–æˆåŠŸ', data);
                } else {
                    showResult('calendarResult', false, data.detail || 'è·å–å¤±è´¥', data);
                }
            } catch (error) {
                console.error('[é”™è¯¯]', error);
                console.log('='.repeat(80));
                showResult('calendarResult', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
            }
        }

        async function summarizeGame() {
            const sessionId = document.getElementById('sessionId').value;
            const apiUrl = getApiUrl();
            
            if (!sessionId) {
                showResult('summarizeResult', false, 'è¯·è¾“å…¥ä¼šè¯ ID');
                return;
            }
            
            console.log('='.repeat(80));
            console.log('[å‰ç«¯] ç”Ÿæˆæ¸¸æˆæ€»ç»“');
            
            const requestData = {
                session_id: sessionId
            };
            
            console.log('[è¾“å…¥] Request:', JSON.stringify(requestData, null, 2));
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const resultDiv = document.getElementById('summarizeResult');
            resultDiv.className = 'result';
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<strong>â³ æ­£åœ¨ç”Ÿæˆæ¸¸æˆæ€»ç»“...</strong><br>è¿™å¯èƒ½éœ€è¦ 10-30 ç§’ï¼Œè¯·è€å¿ƒç­‰å¾…';
            
            try {
                const startTime = Date.now();
                console.log('[è¯·æ±‚] POST', `${apiUrl}/api/game/summarize`);
                
                const response = await fetch(`${apiUrl}/api/game/summarize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const endTime = Date.now();
                const duration = ((endTime - startTime) / 1000).toFixed(2);
                
                console.log('[å“åº”] çŠ¶æ€ç :', response.status);
                console.log('[å“åº”] è€—æ—¶:', duration, 'ç§’');
                
                const data = await response.json();
                console.log('[è¾“å‡º] Response:', JSON.stringify(data, null, 2));
                console.log('='.repeat(80));
                
                if (response.ok) {
                    const summary = data.summary || {};
                    
                    let html = `<strong>âœ… æ¸¸æˆæ€»ç»“ç”ŸæˆæˆåŠŸï¼</strong><br>`;
                    html += `<div style="margin-top: 15px; text-align: left;">`;
                    
                    // æ•´ä½“è¯„ä»·
                    if (summary.overall_assessment) {
                        html += `<h3 style="color: #667eea; margin-bottom: 10px;">ğŸ“‹ æ•´ä½“è¯„ä»·</h3>`;
                        html += `<p style="line-height: 1.6; margin-bottom: 15px;">${summary.overall_assessment.substring(0, 300)}...</p>`;
                    }
                    
                    // æˆåŠŸç¨‹åº¦
                    if (summary.success_level) {
                        const levelEmoji = {
                            'excellent': 'ğŸŒŸ',
                            'good': 'ğŸ‘',
                            'fair': 'ğŸ‘Œ',
                            'poor': 'ğŸ˜”'
                        };
                        html += `<p><strong>æˆåŠŸç¨‹åº¦ï¼š</strong>${levelEmoji[summary.success_level] || ''} ${summary.success_level}</p>`;
                    }
                    
                    // ç›®æ ‡è¾¾æˆ
                    if (summary.goal_achievement) {
                        html += `<h3 style="color: #667eea; margin: 15px 0 10px;">ğŸ¯ ç›®æ ‡è¾¾æˆ</h3>`;
                        html += `<p><strong>ä¸»è¦ç›®æ ‡ï¼š</strong>${summary.goal_achievement.primary_goal_achieved ? 'âœ… å·²è¾¾æˆ' : 'âŒ æœªè¾¾æˆ'}</p>`;
                        if (summary.goal_achievement.achievement_details) {
                            html += `<p>${summary.goal_achievement.achievement_details.substring(0, 200)}...</p>`;
                        }
                    }
                    
                    // ç»´åº¦è¿›å±•
                    if (summary.dimension_progress && summary.dimension_progress.length > 0) {
                        html += `<h3 style="color: #667eea; margin: 15px 0 10px;">ğŸ“Š ç»´åº¦è¿›å±•</h3>`;
                        html += `<ul>`;
                        summary.dimension_progress.slice(0, 3).forEach(dim => {
                            html += `<li><strong>${dim.dimension_name}:</strong> ${dim.performance_score}/10`;
                            if (dim.progress_description) {
                                html += ` - ${dim.progress_description.substring(0, 100)}...`;
                            }
                            html += `</li>`;
                        });
                        if (summary.dimension_progress.length > 3) {
                            html += `<li>... è¿˜æœ‰ ${summary.dimension_progress.length - 3} ä¸ªç»´åº¦</li>`;
                        }
                        html += `</ul>`;
                    }
                    
                    // äº®ç‚¹æ—¶åˆ»
                    if (summary.highlights && summary.highlights.length > 0) {
                        html += `<h3 style="color: #667eea; margin: 15px 0 10px;">âœ¨ äº®ç‚¹æ—¶åˆ»</h3>`;
                        html += `<ul>`;
                        summary.highlights.forEach((highlight, i) => {
                            html += `<li>${highlight}</li>`;
                        });
                        html += `</ul>`;
                    }
                    
                    // æ”¹è¿›å»ºè®®
                    if (summary.areas_for_improvement && summary.areas_for_improvement.length > 0) {
                        html += `<h3 style="color: #667eea; margin: 15px 0 10px;">ğŸ’¡ æ”¹è¿›å»ºè®®</h3>`;
                        html += `<ul>`;
                        summary.areas_for_improvement.forEach(area => {
                            html += `<li>${area}</li>`;
                        });
                        html += `</ul>`;
                    }
                    
                    // ä¸‹æ¬¡å»ºè®®
                    if (summary.recommendations_for_next && summary.recommendations_for_next.length > 0) {
                        html += `<h3 style="color: #667eea; margin: 15px 0 10px;">ğŸ”® ä¸‹æ¬¡å»ºè®®</h3>`;
                        html += `<ul>`;
                        summary.recommendations_for_next.forEach(rec => {
                            html += `<li>${rec}</li>`;
                        });
                        html += `</ul>`;
                    }
                    
                    html += `</div>`;
                    html += `<details style="margin-top: 15px;"><summary style="cursor: pointer; color: #667eea; font-weight: bold;">æŸ¥çœ‹å®Œæ•´ JSON å“åº”</summary>`;
                    html += `<pre style="margin-top: 10px; max-height: 300px; overflow-y: auto;">${JSON.stringify(data, null, 2)}</pre>`;
                    html += `</details>`;
                    
                    showResult('summarizeResult', true, '', html);
                } else {
                    showResult('summarizeResult', false, data.detail || 'æ€»ç»“å¤±è´¥', data);
                }
            } catch (error) {
                console.error('[é”™è¯¯]', error);
                console.log('='.repeat(80));
                showResult('summarizeResult', false, `ç½‘ç»œé”™è¯¯: ${error.message}`);
            }
        }

        async function testAllApis() {
            const childId = getChildId();
            const apiUrl = getApiUrl();
            
            let results = [];
            
            console.log('='.repeat(80));
            console.log('[å‰ç«¯] æµ‹è¯•æ‰€æœ‰ API');
            
            // 1. æµ‹è¯•å¥åº·æ£€æŸ¥
            try {
                const r = await fetch(`${apiUrl}/health`);
                results.push({
                    name: 'Health Check',
                    status: r.status,
                    success: r.ok
                });
            } catch (e) {
                results.push({
                    name: 'Health Check',
                    status: 'Error',
                    success: false,
                    error: e.message
                });
            }
            
            // 2. æµ‹è¯•æ¸¸æˆæ—¥å†
            try {
                const r = await fetch(`${apiUrl}/api/game/calendar/${childId}`);
                results.push({
                    name: 'Game Calendar',
                    status: r.status,
                    success: r.ok
                });
            } catch (e) {
                results.push({
                    name: 'Game Calendar',
                    status: 'Error',
                    success: false,
                    error: e.message
                });
            }
            
            console.log('[è¾“å‡º] Results:', results);
            console.log('='.repeat(80));
            
            showResult('testResult', true, 'API æµ‹è¯•å®Œæˆ', results);
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        window.addEventListener('load', () => {
            checkApiStatus();
        });
    </script>
</body>
</html>
