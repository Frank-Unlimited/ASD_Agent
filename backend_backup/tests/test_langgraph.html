<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LangGraph å·¥ä½œæµæµ‹è¯•é¢æ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .panel h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-section {
            margin-bottom: 25px;
        }

        .control-section h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #555;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #48bb78;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #38a169;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #e53e3e;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        /* å·¥ä½œæµçŠ¶æ€ */
        .workflow-info {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .workflow-info .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .workflow-info .info-item:last-child {
            margin-bottom: 0;
        }

        .workflow-info .label {
            color: #666;
            font-weight: 500;
        }

        .workflow-info .value {
            color: #333;
            font-weight: 600;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-idle {
            background: #e2e8f0;
            color: #4a5568;
        }

        .status-running {
            background: #bee3f8;
            color: #2c5282;
        }

        .status-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-error {
            background: #fed7d7;
            color: #742a2a;
        }

        /* èŠ‚ç‚¹æ‰§è¡Œ */
        .nodes-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .node-btn {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .node-btn:hover:not(:disabled) {
            border-color: #667eea;
            background: #f7fafc;
            transform: translateY(-2px);
        }

        .node-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .node-btn.active {
            border-color: #667eea;
            background: #edf2ff;
        }

        .node-btn.completed {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .node-name {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .node-desc {
            font-size: 11px;
            color: #666;
        }

        .node-status {
            font-size: 10px;
            margin-top: 6px;
            color: #999;
        }

        /* åé¦ˆè¡¨å• */
        .feedback-form {
            display: none;
            background: #fffaf0;
            border: 2px solid #f6ad55;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .feedback-form.show {
            display: block;
        }

        .feedback-form h3 {
            color: #dd6b20;
            margin-bottom: 15px;
        }

        .feedback-form textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 2px solid #fbd38d;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
        }

        .feedback-form textarea:focus {
            outline: none;
            border-color: #f6ad55;
        }

        /* è¾“å‡ºé¢æ¿ */
        .output-section {
            margin-bottom: 20px;
        }

        .output-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .output-tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .output-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .output-content {
            display: none;
        }

        .output-content.active {
            display: block;
        }

        .output-box {
            background: #f7fafc;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
            background: white;
        }

        .log-entry .timestamp {
            color: #999;
            font-size: 11px;
        }

        .log-entry .message {
            color: #333;
            margin-top: 4px;
        }

        .log-entry.success {
            border-left: 4px solid #48bb78;
        }

        .log-entry.error {
            border-left: 4px solid #f56565;
        }

        .log-entry.info {
            border-left: 4px solid #4299e1;
        }

        /* å“åº”å¼ */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .nodes-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§© LangGraph å·¥ä½œæµæµ‹è¯•é¢æ¿</h1>
            <p>ASD åœ°æ¿æ—¶å…‰å¹²é¢„è¾…åŠ©ç³»ç»Ÿ - å·¥ä½œæµå¯è§†åŒ–æµ‹è¯•å·¥å…·</p>
        </div>

        <div class="main-content">
            <!-- å·¦ä¾§ï¼šæ§åˆ¶é¢æ¿ -->
            <div class="panel">
                <h2>âš™ï¸ æ§åˆ¶é¢æ¿</h2>

                <!-- API é…ç½® -->
                <div class="control-section">
                    <h3>API é…ç½®</h3>
                    <div class="input-group">
                        <label>API åœ°å€</label>
                        <input type="text" id="apiUrl" value="http://localhost:7860" placeholder="http://localhost:7860">
                    </div>
                </div>

                <!-- å·¥ä½œæµåˆå§‹åŒ– -->
                <div class="control-section">
                    <h3>1. åˆå§‹åŒ–å·¥ä½œæµ</h3>
                    <div class="input-group">
                        <label>å­©å­ID</label>
                        <input type="text" id="childId" value="child-001" placeholder="child-001">
                    </div>
                    <div class="input-group">
                        <label>å­©å­å§“å</label>
                        <input type="text" id="childName" value="è¾°è¾°" placeholder="è¾°è¾°">
                    </div>
                    <div class="input-group">
                        <label>æŠ¥å‘Šè·¯å¾„</label>
                        <input type="text" id="reportPath" value="/mock/report.pdf" placeholder="/mock/report.pdf">
                    </div>
                    <div class="input-group">
                        <label>æ¸¸æˆID</label>
                        <input type="text" id="gameId" value="game-001" placeholder="game-001">
                    </div>
                    <button class="btn btn-primary" id="initBtn" onclick="initWorkflow()">
                        ğŸš€ åˆå§‹åŒ–å·¥ä½œæµ
                    </button>
                </div>

                <!-- å·¥ä½œæµçŠ¶æ€ -->
                <div class="control-section">
                    <h3>å·¥ä½œæµçŠ¶æ€</h3>
                    <div class="workflow-info" id="workflowInfo">
                        <div class="info-item">
                            <span class="label">çŠ¶æ€:</span>
                            <span class="value"><span class="status-badge status-idle">æœªåˆå§‹åŒ–</span></span>
                        </div>
                        <div class="info-item">
                            <span class="label">å·¥ä½œæµID:</span>
                            <span class="value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">å½“å‰èŠ‚ç‚¹:</span>
                            <span class="value">-</span>
                        </div>
                        <div class="info-item">
                            <span class="label">ä¸‹ä¸€èŠ‚ç‚¹:</span>
                            <span class="value">-</span>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" id="refreshBtn" onclick="refreshStatus()" disabled>
                            ğŸ”„ åˆ·æ–°çŠ¶æ€
                        </button>
                        <button class="btn btn-danger" id="resetBtn" onclick="resetWorkflow()" disabled>
                            ğŸ—‘ï¸ é‡ç½®
                        </button>
                    </div>
                </div>

                <!-- èŠ‚ç‚¹æ‰§è¡Œ -->
                <div class="control-section">
                    <h3>2. æ‰§è¡ŒèŠ‚ç‚¹</h3>
                    <div class="nodes-grid" id="nodesGrid">
                        <!-- èŠ‚ç‚¹æŒ‰é’®å°†é€šè¿‡ JS ç”Ÿæˆ -->
                    </div>
                    <button class="btn btn-secondary" id="autoRunBtn" onclick="autoRunWorkflow()" disabled>
                        âš¡ è‡ªåŠ¨æ‰§è¡Œå…¨æµç¨‹
                    </button>
                </div>

                <!-- HITL åé¦ˆ -->
                <div class="feedback-form" id="feedbackForm">
                    <h3>ğŸ“ å®¶é•¿åé¦ˆè¡¨å•</h3>
                    <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                        è¯·å¡«å†™æœ¬æ¬¡æ¸¸æˆçš„åé¦ˆï¼ˆè¿™æ˜¯ HITL äººæœºåä½œæš‚åœç‚¹ï¼‰
                    </p>
                    <div class="input-group">
                        <label>æ•´ä½“æ„Ÿå—</label>
                        <textarea id="feedbackFeeling" placeholder="ä¾‹å¦‚ï¼šå­©å­ä»Šå¤©ç‰¹åˆ«å¼€å¿ƒï¼Œäº’åŠ¨å¾ˆç§¯æ"></textarea>
                    </div>
                    <div class="input-group">
                        <label>è§‚å¯Ÿåˆ°çš„è¿›æ­¥</label>
                        <textarea id="feedbackProgress" placeholder="ä¾‹å¦‚ï¼šä¸»åŠ¨å‘èµ·äº†3æ¬¡äº’åŠ¨ï¼Œæ¯”ä¸Šæ¬¡å¤šäº†"></textarea>
                    </div>
                    <div class="input-group">
                        <label>é‡åˆ°çš„å›°éš¾</label>
                        <textarea id="feedbackDifficulty" placeholder="ä¾‹å¦‚ï¼šæ³¨æ„åŠ›å®¹æ˜“åˆ†æ•£ï¼Œéœ€è¦å¤šæ¬¡å¼•å¯¼"></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="submitFeedback()">
                        âœ… æäº¤åé¦ˆå¹¶ç»§ç»­
                    </button>
                </div>
            </div>

            <!-- å³ä¾§ï¼šè¾“å‡ºé¢æ¿ -->
            <div class="panel">
                <h2>ğŸ“Š è¾“å‡ºé¢æ¿</h2>

                <div class="output-section">
                    <div class="output-tabs">
                        <button class="output-tab active" onclick="switchTab('logs')">æ‰§è¡Œæ—¥å¿—</button>
                        <button class="output-tab" onclick="switchTab('state')">State çŠ¶æ€</button>
                        <button class="output-tab" onclick="switchTab('response')">å“åº”æ•°æ®</button>
                    </div>

                    <!-- æ‰§è¡Œæ—¥å¿— -->
                    <div class="output-content active" id="logsContent">
                        <div id="logsBox" class="output-box">
                            <div class="log-entry info">
                                <div class="timestamp">ç³»ç»Ÿå¯åŠ¨</div>
                                <div class="message">ç­‰å¾…åˆå§‹åŒ–å·¥ä½œæµ...</div>
                            </div>
                        </div>
                    </div>

                    <!-- State çŠ¶æ€ -->
                    <div class="output-content" id="stateContent">
                        <div id="stateBox" class="output-box">
                            æš‚æ— æ•°æ®
                        </div>
                    </div>

                    <!-- å“åº”æ•°æ® -->
                    <div class="output-content" id="responseContent">
                        <div id="responseBox" class="output-box">
                            æš‚æ— æ•°æ®
                        </div>
                    </div>
                </div>

                <!-- å¿«æ·æ“ä½œ -->
                <div class="control-section" style="margin-top: 20px;">
                    <h3>å¿«æ·æ“ä½œ</h3>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="clearLogs()">
                            ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
                        </button>
                        <button class="btn btn-secondary" onclick="exportLogs()">
                            ğŸ’¾ å¯¼å‡ºæ—¥å¿—
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let currentWorkflowId = null;
        let currentState = null;
        let lastResponse = null;
        let isRunning = false;
        let completedNodes = new Set();

        // èŠ‚ç‚¹é…ç½®
        const NODES = [
            { name: 'assessment', label: 'è¯„ä¼°', desc: 'è§£ææŠ¥å‘Šæ„å»ºç”»åƒ' },
            { name: 'weekly_plan', label: 'å‘¨è®¡åˆ’', desc: 'ç”Ÿæˆä¸ªæ€§åŒ–è®¡åˆ’' },
            { name: 'game_start', label: 'æ¸¸æˆå¼€å§‹', desc: 'åˆ›å»ºæ¸¸æˆä¼šè¯' },
            { name: 'game_end', label: 'æ¸¸æˆç»“æŸ', desc: 'ç»“æŸæ¸¸æˆä¼šè¯' },
            { name: 'preliminary_summary', label: 'åˆæ­¥æ€»ç»“', desc: 'ç”Ÿæˆåˆæ­¥æ€»ç»“' },
            { name: 'feedback_form', label: 'åé¦ˆè¡¨', desc: 'HITLæš‚åœç‚¹' },
            { name: 'final_summary', label: 'æœ€ç»ˆæ€»ç»“', desc: 'èåˆåé¦ˆæ€»ç»“' },
            { name: 'memory_update', label: 'è®°å¿†æ›´æ–°', desc: 'æ›´æ–°Graphiti' },
            { name: 'reassessment', label: 'å†è¯„ä¼°', desc: 'é‡æ–°è¯„ä¼°è°ƒæ•´' },
        ];

        // åˆå§‹åŒ–èŠ‚ç‚¹ç½‘æ ¼
        function initNodesGrid() {
            const grid = document.getElementById('nodesGrid');
            grid.innerHTML = NODES.map(node => `
                <button class="node-btn" id="node-${node.name}" onclick="executeNode('${node.name}')" disabled>
                    <div class="node-name">${node.label}</div>
                    <div class="node-desc">${node.desc}</div>
                    <div class="node-status" id="status-${node.name}">å¾…æ‰§è¡Œ</div>
                </button>
            `).join('');
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tab) {
            document.querySelectorAll('.output-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.output-content').forEach(c => c.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`${tab}Content`).classList.add('active');
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const logsBox = document.getElementById('logsBox');
            const timestamp = new Date().toLocaleTimeString('zh-CN');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `
                <div class="timestamp">${timestamp}</div>
                <div class="message">${message}</div>
            `;
            logsBox.appendChild(logEntry);
            logsBox.scrollTop = logsBox.scrollHeight;
        }

        // æ›´æ–°å·¥ä½œæµä¿¡æ¯
        function updateWorkflowInfo(data) {
            const info = document.getElementById('workflowInfo');
            const status = data.success ? 'running' : 'error';
            info.innerHTML = `
                <div class="info-item">
                    <span class="label">çŠ¶æ€:</span>
                    <span class="value"><span class="status-badge status-${status}">${data.success ? 'è¿è¡Œä¸­' : 'é”™è¯¯'}</span></span>
                </div>
                <div class="info-item">
                    <span class="label">å·¥ä½œæµID:</span>
                    <span class="value">${data.workflowId || currentWorkflowId || '-'}</span>
                </div>
                <div class="info-item">
                    <span class="label">å½“å‰èŠ‚ç‚¹:</span>
                    <span class="value">${data.currentNode || '-'}</span>
                </div>
                <div class="info-item">
                    <span class="label">ä¸‹ä¸€èŠ‚ç‚¹:</span>
                    <span class="value">${data.nextNode || '-'}</span>
                </div>
            `;
        }

        // æ›´æ–°èŠ‚ç‚¹çŠ¶æ€
        function updateNodeStatus(nodeName, status) {
            const nodeBtn = document.getElementById(`node-${nodeName}`);
            const statusText = document.getElementById(`status-${nodeName}`);

            if (status === 'running') {
                nodeBtn.classList.add('active');
                statusText.textContent = 'æ‰§è¡Œä¸­...';
            } else if (status === 'completed') {
                nodeBtn.classList.remove('active');
                nodeBtn.classList.add('completed');
                statusText.textContent = 'âœ“ å·²å®Œæˆ';
                completedNodes.add(nodeName);
            } else if (status === 'error') {
                nodeBtn.classList.remove('active');
                statusText.textContent = 'âœ— å¤±è´¥';
            }
        }

        // åˆå§‹åŒ–å·¥ä½œæµ
        async function initWorkflow() {
            const apiUrl = document.getElementById('apiUrl').value;
            const childId = document.getElementById('childId').value;
            const childName = document.getElementById('childName').value;
            const reportPath = document.getElementById('reportPath').value;
            const gameId = document.getElementById('gameId').value;

            addLog('ğŸš€ å¼€å§‹åˆå§‹åŒ–å·¥ä½œæµ...', 'info');

            try {
                const response = await fetch(`${apiUrl}/api/workflow/init`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ childId, childName, reportPath, gameId })
                });

                const data = await response.json();
                lastResponse = data;

                if (data.success) {
                    currentWorkflowId = data.workflowId;
                    currentState = data.state;

                    addLog(`âœ… å·¥ä½œæµåˆå§‹åŒ–æˆåŠŸ: ${currentWorkflowId}`, 'success');
                    updateWorkflowInfo(data);
                    updateStateDisplay();
                    updateResponseDisplay();

                    // å¯ç”¨æŒ‰é’®
                    document.querySelectorAll('.node-btn').forEach(btn => btn.disabled = false);
                    document.getElementById('refreshBtn').disabled = false;
                    document.getElementById('resetBtn').disabled = false;
                    document.getElementById('autoRunBtn').disabled = false;
                    document.getElementById('initBtn').disabled = true;
                } else {
                    throw new Error(data.message || 'åˆå§‹åŒ–å¤±è´¥');
                }
            } catch (error) {
                addLog(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // æ‰§è¡Œå•ä¸ªèŠ‚ç‚¹
        async function executeNode(nodeName) {
            if (!currentWorkflowId || isRunning) return;

            const apiUrl = document.getElementById('apiUrl').value;
            isRunning = true;
            updateNodeStatus(nodeName, 'running');
            addLog(`â–¶ï¸ æ‰§è¡ŒèŠ‚ç‚¹: ${nodeName}`, 'info');

            try {
                const response = await fetch(`${apiUrl}/api/workflow/${currentWorkflowId}/execute/${nodeName}`, {
                    method: 'POST'
                });

                const data = await response.json();
                lastResponse = data;

                if (data.success) {
                    currentState = data.state;
                    updateNodeStatus(nodeName, 'completed');
                    addLog(`âœ… èŠ‚ç‚¹æ‰§è¡ŒæˆåŠŸ: ${nodeName} (è€—æ—¶: ${data.executionTime?.toFixed(2)}s)`, 'success');
                    updateWorkflowInfo(data);
                    updateStateDisplay();
                    updateResponseDisplay();

                    // ç‰¹æ®Šå¤„ç†ï¼šfeedback_form èŠ‚ç‚¹åæ˜¾ç¤ºåé¦ˆè¡¨å•
                    if (nodeName === 'feedback_form') {
                        document.getElementById('feedbackForm').classList.add('show');
                        addLog('â¸ï¸ å·¥ä½œæµå·²æš‚åœï¼Œç­‰å¾…å®¶é•¿å¡«å†™åé¦ˆ...', 'info');
                    }
                } else {
                    throw new Error(data.message || 'èŠ‚ç‚¹æ‰§è¡Œå¤±è´¥');
                }
            } catch (error) {
                updateNodeStatus(nodeName, 'error');
                addLog(`âŒ èŠ‚ç‚¹æ‰§è¡Œå¤±è´¥: ${nodeName} - ${error.message}`, 'error');
                console.error(error);
            } finally {
                isRunning = false;
            }
        }

        // æäº¤åé¦ˆ
        async function submitFeedback() {
            if (!currentWorkflowId) return;

            const apiUrl = document.getElementById('apiUrl').value;
            const feedback = {
                feeling: document.getElementById('feedbackFeeling').value,
                progress: document.getElementById('feedbackProgress').value,
                difficulty: document.getElementById('feedbackDifficulty').value,
            };

            addLog('ğŸ“ æäº¤å®¶é•¿åé¦ˆ...', 'info');

            try {
                const response = await fetch(`${apiUrl}/api/workflow/${currentWorkflowId}/submit-feedback`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feedback })
                });

                const data = await response.json();
                lastResponse = data;

                if (data.success) {
                    currentState = data.state;
                    addLog('âœ… åé¦ˆæäº¤æˆåŠŸï¼Œå·¥ä½œæµç»§ç»­æ‰§è¡Œ', 'success');
                    updateWorkflowInfo(data);
                    updateStateDisplay();
                    updateResponseDisplay();
                    document.getElementById('feedbackForm').classList.remove('show');
                } else {
                    throw new Error(data.message || 'åé¦ˆæäº¤å¤±è´¥');
                }
            } catch (error) {
                addLog(`âŒ åé¦ˆæäº¤å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // è‡ªåŠ¨è¿è¡Œå…¨æµç¨‹
        async function autoRunWorkflow() {
            if (!currentWorkflowId || isRunning) return;

            addLog('âš¡ å¼€å§‹è‡ªåŠ¨æ‰§è¡Œå…¨æµç¨‹...', 'info');
            document.getElementById('autoRunBtn').disabled = true;

            for (const node of NODES) {
                if (completedNodes.has(node.name)) continue;

                await executeNode(node.name);

                // åœ¨ feedback_form èŠ‚ç‚¹æš‚åœ
                if (node.name === 'feedback_form') {
                    addLog('â¸ï¸ è‡ªåŠ¨æ‰§è¡Œå·²æš‚åœï¼Œè¯·å¡«å†™åé¦ˆåæ‰‹åŠ¨ç»§ç»­', 'info');
                    document.getElementById('autoRunBtn').disabled = false;
                    return;
                }

                // å»¶è¿Ÿ 1 ç§’
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            addLog('ğŸ‰ å…¨æµç¨‹æ‰§è¡Œå®Œæˆï¼', 'success');
            document.getElementById('autoRunBtn').disabled = false;
        }

        // åˆ·æ–°çŠ¶æ€
        async function refreshStatus() {
            if (!currentWorkflowId) return;

            const apiUrl = document.getElementById('apiUrl').value;
            addLog('ğŸ”„ åˆ·æ–°å·¥ä½œæµçŠ¶æ€...', 'info');

            try {
                const response = await fetch(`${apiUrl}/api/workflow/${currentWorkflowId}/status`);
                const data = await response.json();
                lastResponse = data;

                if (data.success) {
                    currentState = data.state;
                    addLog('âœ… çŠ¶æ€åˆ·æ–°æˆåŠŸ', 'success');
                    updateWorkflowInfo(data);
                    updateStateDisplay();
                    updateResponseDisplay();
                } else {
                    throw new Error(data.message || 'åˆ·æ–°å¤±è´¥');
                }
            } catch (error) {
                addLog(`âŒ åˆ·æ–°å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // é‡ç½®å·¥ä½œæµ
        async function resetWorkflow() {
            if (!currentWorkflowId) return;
            if (!confirm('ç¡®å®šè¦é‡ç½®å·¥ä½œæµå—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰æ•°æ®ã€‚')) return;

            const apiUrl = document.getElementById('apiUrl').value;
            addLog('ğŸ—‘ï¸ é‡ç½®å·¥ä½œæµ...', 'info');

            try {
                const response = await fetch(`${apiUrl}/api/workflow/${currentWorkflowId}/reset`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    addLog('âœ… å·¥ä½œæµå·²é‡ç½®', 'success');

                    // é‡ç½®çŠ¶æ€
                    currentWorkflowId = null;
                    currentState = null;
                    lastResponse = null;
                    completedNodes.clear();

                    // é‡ç½® UI
                    document.querySelectorAll('.node-btn').forEach(btn => {
                        btn.disabled = true;
                        btn.classList.remove('active', 'completed');
                    });
                    document.querySelectorAll('.node-status').forEach(status => {
                        status.textContent = 'å¾…æ‰§è¡Œ';
                    });
                    document.getElementById('feedbackForm').classList.remove('show');
                    document.getElementById('initBtn').disabled = false;
                    document.getElementById('refreshBtn').disabled = true;
                    document.getElementById('resetBtn').disabled = true;
                    document.getElementById('autoRunBtn').disabled = true;

                    updateWorkflowInfo({ success: false, message: 'æœªåˆå§‹åŒ–' });
                    document.getElementById('stateBox').textContent = 'æš‚æ— æ•°æ®';
                    document.getElementById('responseBox').textContent = 'æš‚æ— æ•°æ®';
                } else {
                    throw new Error(data.message || 'é‡ç½®å¤±è´¥');
                }
            } catch (error) {
                addLog(`âŒ é‡ç½®å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // æ›´æ–° State æ˜¾ç¤º
        function updateStateDisplay() {
            const stateBox = document.getElementById('stateBox');
            if (currentState) {
                stateBox.textContent = JSON.stringify(currentState, null, 2);
            }
        }

        // æ›´æ–°å“åº”æ˜¾ç¤º
        function updateResponseDisplay() {
            const responseBox = document.getElementById('responseBox');
            if (lastResponse) {
                responseBox.textContent = JSON.stringify(lastResponse, null, 2);
            }
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            const logsBox = document.getElementById('logsBox');
            logsBox.innerHTML = '<div class="log-entry info"><div class="timestamp">ç³»ç»Ÿ</div><div class="message">æ—¥å¿—å·²æ¸…ç©º</div></div>';
        }

        // å¯¼å‡ºæ—¥å¿—
        function exportLogs() {
            const logsBox = document.getElementById('logsBox');
            const logs = logsBox.innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `langgraph_logs_${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            addLog('ğŸ’¾ æ—¥å¿—å·²å¯¼å‡º', 'success');
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            initNodesGrid();
            addLog('âœ¨ æµ‹è¯•é¢æ¿å·²å°±ç»ª', 'info');
            addLog('è¯·å…ˆç‚¹å‡»"åˆå§‹åŒ–å·¥ä½œæµ"æŒ‰é’®å¼€å§‹æµ‹è¯•', 'info');
        };
    </script>
</body>
</html>
