<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</title>
    <link rel="stylesheet" href="../common/styles.css">
</head>
<body>
    <div class="container">
        <h1>ğŸ“¤ æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h1>
        
        <div class="section">
            <h2>ä¸Šä¼ æ–‡ä»¶</h2>
            <div class="form-group">
                <label>é€‰æ‹©æ–‡ä»¶ï¼š</label>
                <input type="file" id="fileInput" accept="image/*,video/*,audio/*,.pdf,.doc,.docx">
            </div>
            
            <div class="form-group">
                <label>æ–‡ä»¶åˆ†ç±»ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                <select id="categorySelect">
                    <option value="">è‡ªåŠ¨æ£€æµ‹</option>
                    <option value="image">å›¾ç‰‡</option>
                    <option value="document">æ–‡æ¡£</option>
                    <option value="audio">éŸ³é¢‘</option>
                    <option value="video">è§†é¢‘</option>
                </select>
            </div>
            
            <button onclick="uploadFile()" class="btn-primary">ä¸Šä¼ æ–‡ä»¶</button>
        </div>

        <div class="section">
            <h2>ğŸ“¥ ä¸Šä¼ ç»“æœ</h2>
            <div id="result" class="result"></div>
        </div>

        <div class="section">
            <h2>ğŸ’¡ ä½¿ç”¨è¯´æ˜</h2>
            <ul>
                <li>æ”¯æŒçš„å›¾ç‰‡æ ¼å¼ï¼šJPG, JPEG, PNG, BMP, WEBP</li>
                <li>æ”¯æŒçš„æ–‡æ¡£æ ¼å¼ï¼šPDF, DOCX, DOC</li>
                <li>æ”¯æŒçš„éŸ³é¢‘æ ¼å¼ï¼šMP3, WAV, PCM, M4A, AAC, FLAC, OGG</li>
                <li>æ”¯æŒçš„è§†é¢‘æ ¼å¼ï¼šMP4, AVI, MOV, MKV</li>
                <li>æœ€å¤§æ–‡ä»¶å¤§å°ï¼š100MB</li>
                <li>ä¸Šä¼ åä¼šè¿”å›æ–‡ä»¶çš„å®Œæ•´è·¯å¾„ï¼Œå¯ç”¨äºåç»­çš„æ–‡æ¡£è§£æã€è§†é¢‘åˆ†æç­‰æ“ä½œ</li>
            </ul>
        </div>
    </div>

    <script src="../common/api-client.js"></script>
    <script>
        // å¤åˆ¶è·¯å¾„åˆ°å‰ªè´´æ¿
        function copyPath() {
            const path = window.lastUploadedPath;
            if (path) {
                navigator.clipboard.writeText(path).then(() => {
                    alert('âœ… æ–‡ä»¶è·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\n' + path);
                }).catch(err => {
                    // é™çº§æ–¹æ¡ˆ
                    const textarea = document.createElement('textarea');
                    textarea.value = path;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    alert('âœ… æ–‡ä»¶è·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\n' + path);
                });
            }
        }
        
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const categorySelect = document.getElementById('categorySelect');
            const resultDiv = document.getElementById('result');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                resultDiv.innerHTML = '<div class="error">è¯·å…ˆé€‰æ‹©æ–‡ä»¶</div>';
                return;
            }
            
            const file = fileInput.files[0];
            const category = categorySelect.value;
            
            resultDiv.innerHTML = '<div class="loading">æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...</div>';
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                if (category) {
                    formData.append('category', category);
                }
                
                const response = await fetch('http://localhost:7860/api/infrastructure/file_upload/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // æ‰“å°åˆ°æ§åˆ¶å°ï¼Œæ–¹ä¾¿æŸ¥çœ‹å®é™…æ•°æ®
                    console.log('ä¸Šä¼ æˆåŠŸï¼Œè¿”å›æ•°æ®:', result.data);
                    console.log('æ–‡ä»¶è·¯å¾„ï¼ˆå®é™…å€¼ï¼‰:', JSON.stringify(result.data.file_path));
                    
                    // ä¿å­˜è·¯å¾„åˆ°å…¨å±€å˜é‡ï¼Œæ–¹ä¾¿å¤åˆ¶
                    window.lastUploadedPath = result.data.file_path;
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>âœ… ä¸Šä¼ æˆåŠŸ</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>æ–‡ä»¶è·¯å¾„ï¼š</strong>
                                    <code id="filePath">${result.data.file_path}</code>
                                    <button onclick="copyPath()" style="margin-left: 10px; padding: 2px 8px; cursor: pointer;">ğŸ“‹ å¤åˆ¶</button>
                                </div>
                                <div class="info-item">
                                    <strong>æ–‡ä»¶åï¼š</strong>
                                    <span>${result.data.filename}</span>
                                </div>
                                <div class="info-item">
                                    <strong>åŸå§‹æ–‡ä»¶åï¼š</strong>
                                    <span>${result.data.original_filename}</span>
                                </div>
                                <div class="info-item">
                                    <strong>æ–‡ä»¶å¤§å°ï¼š</strong>
                                    <span>${(result.data.file_size / 1024).toFixed(2)} KB</span>
                                </div>
                                <div class="info-item">
                                    <strong>æ–‡ä»¶åˆ†ç±»ï¼š</strong>
                                    <span>${result.data.category}</span>
                                </div>
                            </div>
                            <div class="tip">
                                ğŸ’¡ æç¤ºï¼šç‚¹å‡»"å¤åˆ¶"æŒ‰é’®å¤åˆ¶æ–‡ä»¶è·¯å¾„ï¼Œå¯ä»¥åœ¨æ–‡æ¡£è§£æã€è§†é¢‘åˆ†æç­‰æ¥å£ä¸­ä½¿ç”¨
                            </div>
                            <details style="margin-top: 15px; padding: 10px; background: #f5f5f5; border-radius: 4px;">
                                <summary style="cursor: pointer; font-weight: 600;">ğŸ” æŸ¥çœ‹åŸå§‹ JSON æ•°æ®</summary>
                                <pre style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px; overflow-x: auto;">${JSON.stringify(result.data, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">ä¸Šä¼ å¤±è´¥ï¼š${result.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">ä¸Šä¼ å¤±è´¥ï¼š${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
