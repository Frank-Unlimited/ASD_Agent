<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>周计划推荐服务 - 测试页面</title>
    <link rel="stylesheet" href="../common/styles.css">
</head>
<body>
    <div class="header">
        <div class="container">
            <a href="../index.html" class="back-link">← 返回导航</a>
            <h1>周计划推荐服务</h1>
            <div class="subtitle">生成个性化周干预计划,计算优先维度 | 模块 8</div>
        </div>
    </div>

    <div class="container">
        <!-- 接口 1: 生成周计划 -->
        <div class="card">
            <div class="card-header">1. 生成周计划</div>
            <div class="card-description">基于孩子档案和当前上下文生成本周干预计划</div>

            <form id="form-generate-plan">
                <div class="form-group">
                    <label class="form-label">孩子 ID *</label>
                    <input type="text" class="form-input" name="child_id" placeholder="例如: child-001" required>
                </div>

                <div class="form-group">
                    <label class="form-label">孩子档案 (JSON) *</label>
                    <textarea class="form-textarea" name="child_profile" rows="8" placeholder='输入 JSON 格式的孩子档案' required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">当前上下文 (JSON) *</label>
                    <textarea class="form-textarea" name="current_context" rows="6" placeholder='输入 JSON 格式的当前上下文' required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">上周表现 (JSON,可选)</label>
                    <textarea class="form-textarea" name="last_week_performance" rows="5" placeholder='输入 JSON 格式的上周表现数据'></textarea>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn btn-primary" onclick="testGeneratePlan()">执行请求</button>
                    <button type="button" class="btn btn-secondary" onclick="fillExampleGeneratePlan()">填充示例</button>
                    <button type="reset" class="btn btn-secondary">清空</button>
                </div>
            </form>

            <div id="request-generate-plan"></div>
            <div id="response-generate-plan"></div>
        </div>

        <!-- 接口 2: 计算优先维度 -->
        <div class="card">
            <div class="card-header">2. 计算优先维度</div>
            <div class="card-description">根据当前指标和趋势计算本周应优先关注的维度</div>

            <form id="form-calculate-priority">
                <div class="form-group">
                    <label class="form-label">当前指标 (JSON) *</label>
                    <textarea class="form-textarea" name="metrics" rows="8" placeholder='输入 JSON 格式的当前指标数据' required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">趋势数据 (JSON) *</label>
                    <textarea class="form-textarea" name="trends" rows="6" placeholder='输入 JSON 格式的趋势数据' required></textarea>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn btn-primary" onclick="testCalculatePriority()">执行请求</button>
                    <button type="button" class="btn btn-secondary" onclick="fillExampleCalculatePriority()">填充示例</button>
                    <button type="reset" class="btn btn-secondary">清空</button>
                </div>
            </form>

            <div id="request-calculate-priority"></div>
            <div id="response-calculate-priority"></div>
        </div>
    </div>

    <script src="../common/api-client.js"></script>
    <script>
        // 示例数据
        const examples = {
            generatePlan: {
                child_id: "child-001",
                child_profile: {
                    name: "辰辰",
                    age: 36,
                    diagnosis: "ASD轻度",
                    eye_contact: 5.0,
                    joint_attention: 4.5,
                    social_interaction: 4.0,
                    interests: ["旋转物体", "水流", "积木"],
                    strengths: ["专注力好", "记忆力强"]
                },
                current_context: {
                    week_number: 12,
                    recent_progress: ["眼神接触有进步", "开始模仿简单动作"],
                    current_challenges: ["共同注意力仍然较弱", "主动社交意愿低"]
                },
                last_week_performance: {
                    completion_rate: 0.85,
                    eye_contact_improvement: 0.3,
                    joint_attention_improvement: 0.2,
                    feedback: "孩子配合度高,家长执行积极"
                }
            },
            calculatePriority: {
                metrics: {
                    eye_contact: 5.0,
                    joint_attention: 4.5,
                    imitation: 4.0,
                    emotion_understanding: 3.5,
                    social_interaction: 4.0,
                    language_expression: 5.5,
                    language_comprehension: 6.0
                },
                trends: {
                    eye_contact: { trend: "improving", rate: 0.3 },
                    joint_attention: { trend: "improving", rate: 0.2 },
                    imitation: { trend: "stable", rate: 0.0 },
                    emotion_understanding: { trend: "declining", rate: -0.1 },
                    social_interaction: { trend: "stable", rate: 0.05 },
                    language_expression: { trend: "improving", rate: 0.4 },
                    language_comprehension: { trend: "improving", rate: 0.3 }
                }
            }
        };

        // 测试函数
        async function testGeneratePlan() {
            const formData = getFormData('form-generate-plan');
            const data = {
                child_id: formData.child_id,
                child_profile: formData.child_profile,
                current_context: formData.current_context,
                last_week_performance: formData.last_week_performance || null
            };
            displayRequest('request-generate-plan', '/api/business/weekly-plan/generate', data);
            showLoading('response-generate-plan');
            const response = await apiClient.post('/api/business/weekly-plan/generate', data);
            displayResponse('response-generate-plan', response);
        }

        async function testCalculatePriority() {
            const formData = getFormData('form-calculate-priority');
            const data = {
                metrics: formData.metrics,
                trends: formData.trends
            };
            displayRequest('request-calculate-priority', '/api/business/weekly-plan/calculate-priority-dimensions', data);
            showLoading('response-calculate-priority');
            const response = await apiClient.post('/api/business/weekly-plan/calculate-priority-dimensions', data);
            displayResponse('response-calculate-priority', response);
        }

        // 填充示例函数
        function fillExampleGeneratePlan() {
            document.querySelector('#form-generate-plan [name="child_id"]').value = examples.generatePlan.child_id;
            document.querySelector('#form-generate-plan [name="child_profile"]').value = JSON.stringify(examples.generatePlan.child_profile, null, 2);
            document.querySelector('#form-generate-plan [name="current_context"]').value = JSON.stringify(examples.generatePlan.current_context, null, 2);
            document.querySelector('#form-generate-plan [name="last_week_performance"]').value = JSON.stringify(examples.generatePlan.last_week_performance, null, 2);
        }

        function fillExampleCalculatePriority() {
            document.querySelector('#form-calculate-priority [name="metrics"]').value = JSON.stringify(examples.calculatePriority.metrics, null, 2);
            document.querySelector('#form-calculate-priority [name="trends"]').value = JSON.stringify(examples.calculatePriority.trends, null, 2);
        }
    </script>
</body>
</html>
