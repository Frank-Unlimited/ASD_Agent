# ASD Agent 重构进度报告

生成时间: 2026-01-29

## 📋 重构目标

基于用户需求，将系统从固定的LangGraph工作流架构重构为灵活的独立服务架构。

### 核心需求
1. 家长自己在家使用
2. 上传孩子档案图片，LLM解析并归档
3. 随时通过语音记录孩子变化
4. 推荐游戏时评估孩子当前状态+分析趋势+生成详细方案
5. 游戏可"待实施"或"已实施"，实施需记录全过程
6. 查看成长趋势（维度时间线、兴趣热力图、干预效果）
7. 导出医生版专业报告

---

## ✅ 已完成工作

### 1. 代码备份 ✔️
已将即将删除的文件备份到 `backup/` 目录：
- `backup/src/workflow/workflow.py`
- `backup/src/api/workflow.py`
- `backup/services/mock/business_services.py`

### 2. 数据模型设计 ✔️

创建了5个核心数据模型文件（使用Pydantic BaseModel）：

#### `src/models/profile.py` - 孩子档案模型
- `Gender` - 性别枚举
- `DiagnosisLevel` - 诊断级别枚举
- `DevelopmentDimension` - 发展维度
- `InterestPoint` - 兴趣点
- `ParsedProfileData` - LLM解析的档案数据
- `ChildProfile` - 完整档案信息
- `ProfileUpdateRequest` - 更新请求
- `ProfileCreateResponse` - 创建响应

#### `src/models/observation.py` - 观察记录模型
- `ObservationType` - 观察类型（语音/文字/视频/快捷）
- `ObservationDimension` - 观察维度（对应ASD发展领域）
- `ObservationSignificance` - 重要性（突破/改善/正常/关注/退步）
- `EmotionalState` - 情绪状态
- `StructuredObservationData` - LLM提取的结构化数据
- `Observation` - 观察记录
- 各种请求/响应模型

#### `src/models/game.py` - 游戏方案和会话模型
- `GameStatus` - 游戏状态
- `TargetDimension` - 目标维度
- `GameStep` - 游戏步骤
- `GamePrecaution` - 注意事项
- `GameGoal` - 游戏目标
- `GamePlan` - 游戏方案（完整设计）
- `ParentObservation` - 家长观察
- `VideoAnalysisSummary` - 视频分析摘要
- `GameSession` - 游戏会话（实施记录）
- `GameCalendarItem` - 游戏日历条目
- 各种请求/响应模型

#### `src/models/analysis.py` - 趋势分析模型
- `TrendDirection` - 趋势方向
- `TimelineDataPoint` - 时间线数据点
- `DimensionTimeline` - 发展维度时间线
- `InterestHeatmapData` - 兴趣点热力图数据
- `InterventionEffect` - 干预效果
- `ComprehensiveAnalysis` - 综合分析报告
- 各种请求/响应模型

#### `src/models/report.py` - 报告生成模型
- `ReportType` - 报告类型（医生版/家长版/总结）
- `ReportFormat` - 报告格式（PDF/HTML/JSON/Markdown）
- `ChartType` - 图表类型
- `ChartData` - 图表数据
- `DevelopmentDimensionReport` - 发展维度报告
- `InterventionSummary` - 干预总结
- `ObservationSummary` - 观察记录总结
- `MedicalReport` - 医生版报告
- `ParentReport` - 家长版报告
- 各种请求/响应模型

### 3. 档案管理服务实现 ✔️

#### `services/profile/profile_service.py`
实现了完整的档案管理功能：

**核心方法**：
1. `create_profile_from_image()` - 从档案图片创建档案
   - 调用文档解析服务解析图片
   - 使用LLM提取结构化信息（诊断、发展维度、兴趣点等）
   - 生成child_id并创建初步档案
   - 保存到SQLite
   - 返回解析结果

2. `update_profile_info()` - 更新档案信息
   - 家长补充姓名、性别等基本信息
   - 检测首次完善（姓名从"待补充"改为实际姓名）
   - 首次完善时自动将档案信息存入Graphiti
   - 保存更新到SQLite

3. `get_profile()` - 获取档案信息

**依赖服务**：
- `IDocumentParserService` - 解析档案图片
- `ISQLiteService` - 存储档案
- `IGraphitiService` - 保存初始画像到知识图谱
- `LLMService` - 结构化提取档案信息

### 4. 档案管理API实现 ✔️

#### `src/api/profile.py`
提供了3个RESTful API端点：

1. `POST /api/profile/upload` - 上传档案图片
   - 接收文件上传
   - 保存到 `uploads/archives/` 目录
   - 调用档案服务解析
   - 返回child_id和解析数据

2. `PATCH /api/profile/{child_id}` - 补充/更新档案信息
   - 首次补充姓名和性别
   - 后续更新诊断信息、备注等
   - 首次完善时自动存入Graphiti

3. `GET /api/profile/{child_id}` - 获取档案信息
   - 返回完整档案数据

### 5. 服务容器集成 ✔️

#### 更新了 `src/container.py`
- 注册了ProfileService
- 自动注入依赖（document_parser, sqlite, graphiti, llm）

#### 更新了 `src/main.py`
- 导入profile路由
- 注册到FastAPI应用

---

## 🔄 当前系统架构

### 数据流（档案管理）

```
1. 档案创建流程：
   上传图片 → DocumentParser解析 → LLM提取结构化信息
   → 生成child_id → 保存SQLite → 返回解析结果

2. 档案完善流程：
   家长补充信息 → 更新SQLite
   → (首次完善)保存初始画像到Graphiti

3. 档案查询流程：
   查询child_id → 从SQLite获取 → 返回完整档案
```

### 服务依赖关系

```
ProfileService
  ├── IDocumentParserService (解析图片)
  ├── ISQLiteService (存储档案)
  ├── IGraphitiService (保存画像到知识图谱)
  └── LLMService (结构化提取)
```

---

## 📝 接下来的任务

### 任务5：实现观察记录服务 🔜
- `services/observation/observation_service.py`
- 语音 → 文字 → LLM提取 → Graphiti
- 文字观察记录
- 观察历史查询

### 任务6：实现游戏推荐服务 🔜
- `services/game/game_recommender.py`
- 评估 + 趋势分析 + 生成游戏方案
- 游戏日历管理
- 游戏会话管理

### 任务7：清理旧代码 ⏳
- 删除 LangGraph 工作流
- 删除 Mock 业务服务
- 更新 requirements.txt

### 任务8-10：实现其他服务
- 趋势分析服务
- 报告生成服务
- 其他扩展功能

---

## 🎯 关键设计决策

### 1. 移除LangGraph
**原因**：
- 用户需要灵活性，不需要固定流程
- 可以只调用某个功能（如只推荐游戏、只评估）
- LangGraph在这种场景下是过度设计

**替代方案**：
- 独立的服务模块，通过API按需调用
- 保留LangGraph依赖，但只在复杂功能内部使用（可选）

### 2. 使用Pydantic BaseModel
**优势**：
- 自动验证数据
- 易于序列化/反序列化
- 支持默认值和类型提示
- 与FastAPI完美集成

### 3. 服务分层
**基础设施层**：
- SQLite、Graphiti、语音、文档解析、LLM等

**业务服务层**：
- ProfileService、ObservationService、GameService等
- 依赖基础设施层服务

### 4. Graphiti的使用
**时机**：
- 档案首次完善时，保存初始画像
- 观察记录时，保存结构化观察
- 游戏会话结束时，保存干预记录

**作用**：
- 构建时序知识图谱
- 支持趋势分析
- 提供推荐依据

---

## 📊 进度统计

| 模块 | 状态 | 完成度 |
|------|------|--------|
| 数据模型设计 | ✅ 完成 | 100% |
| 档案管理服务 | ✅ 完成 | 100% |
| 档案管理API | ✅ 完成 | 100% |
| 观察记录服务 | 🔜 待开始 | 0% |
| 游戏推荐服务 | 🔜 待开始 | 0% |
| 趋势分析服务 | 🔜 待开始 | 0% |
| 报告生成服务 | 🔜 待开始 | 0% |
| 清理旧代码 | 🔜 待开始 | 0% |

**总体进度**: 25% (2/8 完成)

---

## 🚀 如何测试档案管理功能

### 1. 启动服务
```bash
python src/main.py
```

### 2. 上传档案图片
```bash
curl -X POST "http://localhost:7860/api/profile/upload" \
  -F "file=@path/to/archive.jpg"
```

返回：
```json
{
  "child_id": "child-abc123",
  "name": "待补充",
  "parsed_data": {
    "diagnosis": "自闭症谱系障碍",
    "diagnosis_level": "mild",
    "birth_date": "2020-06-15",
    "key_findings": [...],
    "development_dimensions": [...],
    "interests": ["水流", "旋转物体"]
  },
  "message": "档案图片解析成功，请补充孩子的姓名和性别信息"
}
```

### 3. 补充档案信息
```bash
curl -X PATCH "http://localhost:7860/api/profile/child-abc123" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "辰辰",
    "gender": "male",
    "notes": "对水流特别感兴趣"
  }'
```

### 4. 获取档案
```bash
curl -X GET "http://localhost:7860/api/profile/child-abc123"
```

---

## 📌 注意事项

1. **LLM配置**：确保 `.env` 中配置了 `LLM_API_KEY`
2. **服务开关**：在 `.env` 中设置：
   - `USE_REAL_DOCUMENT_PARSER=true`
   - `USE_REAL_SQLITE=true`
   - `USE_REAL_GRAPHITI=true`
3. **Neo4j**：如果使用真实Graphiti，需要启动Neo4j
4. **上传目录**：系统会自动创建 `uploads/archives/` 目录

---

## 🎉 总结

我们已经成功完成了重构的第一阶段：
- ✅ 设计了完整的数据模型
- ✅ 实现了档案管理功能（从图片上传到LLM解析到存储）
- ✅ 提供了RESTful API接口
- ✅ 集成到主应用中

接下来将继续实现观察记录和游戏推荐功能，这是用户需求中最核心的两个模块。
