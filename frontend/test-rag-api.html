<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RAG çŸ¥è¯†åº“æ£€ç´¢æµ‹è¯•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .header p {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .input-group input,
    .input-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .input-group input:focus,
    .input-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      flex: 1;
      min-width: 150px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .status {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }

    .status.loading {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .results {
      margin-top: 20px;
    }

    .result-item {
      background: #f8f9fa;
      border-left: 4px solid #667eea;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .result-score {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .result-source {
      color: #666;
      font-size: 14px;
      margin-top: 8px;
      font-style: italic;
    }

    .result-text {
      line-height: 1.6;
      color: #333;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 0.9em;
      opacity: 0.9;
    }

    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 14px;
      line-height: 1.5;
    }

    .quick-queries {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .quick-query-btn {
      padding: 8px 16px;
      background: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }

    .quick-query-btn:hover {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .section-title {
      font-size: 1.3em;
      margin-bottom: 15px;
      color: #333;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ” RAG çŸ¥è¯†åº“æ£€ç´¢æµ‹è¯•</h1>
      <p>æµ‹è¯•é˜¿é‡Œäº‘ç™¾ç‚¼çŸ¥è¯†åº“æ£€ç´¢åŠŸèƒ½</p>
    </div>

    <!-- å¥åº·æ£€æŸ¥ -->
    <div class="card">
      <h2 class="section-title">æœåŠ¡çŠ¶æ€</h2>
      <div class="stats" id="stats">
        <div class="stat-card">
          <div class="stat-value" id="statusValue">-</div>
          <div class="stat-label">æœåŠ¡çŠ¶æ€</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="sdkValue">-</div>
          <div class="stat-label">SDK çŠ¶æ€</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="clientValue">-</div>
          <div class="stat-label">å®¢æˆ·ç«¯çŠ¶æ€</div>
        </div>
      </div>
      <button class="btn-secondary" onclick="checkHealth()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
    </div>

    <!-- RAG æ£€ç´¢ -->
    <div class="card">
      <h2 class="section-title">RAG çŸ¥è¯†åº“æ£€ç´¢</h2>
      
      <div class="input-group">
        <label for="ragQuery">æŸ¥è¯¢å†…å®¹</label>
        <input type="text" id="ragQuery" placeholder="ä¾‹å¦‚ï¼šDIR Floortime ç†è®º" value="DIR Floortime åœ°æ¿æ—¶å…‰ç†è®º">
      </div>

      <div class="quick-queries">
        <span style="color: #666; margin-right: 10px;">å¿«é€ŸæŸ¥è¯¢ï¼š</span>
        <button class="quick-query-btn" onclick="setQuery('DIR Floortime ç†è®º')">DIR ç†è®º</button>
        <button class="quick-query-btn" onclick="setQuery('åœ°æ¿æ¸¸æˆæ–¹æ¡ˆ')">æ¸¸æˆæ–¹æ¡ˆ</button>
        <button class="quick-query-btn" onclick="setQuery('å…´è¶£ç»´åº¦åˆ†æ')">å…´è¶£ç»´åº¦</button>
        <button class="quick-query-btn" onclick="setQuery('è¡Œä¸ºè§‚å¯ŸæŒ‡å—')">è¡Œä¸ºè§‚å¯Ÿ</button>
        <button class="quick-query-btn" onclick="setQuery('å®¶é•¿æŒ‡å¯¼ç­–ç•¥')">å®¶é•¿æŒ‡å¯¼</button>
      </div>

      <div class="input-group">
        <label for="topK">è¿”å›ç»“æœæ•°é‡</label>
        <select id="topK">
          <option value="3">3 æ¡</option>
          <option value="5" selected>5 æ¡</option>
          <option value="10">10 æ¡</option>
        </select>
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="searchRAG()" id="ragBtn">ğŸ” æ£€ç´¢ RAG</button>
        <button class="btn-success" onclick="searchKnowledge()" id="knowledgeBtn">ğŸŒ å¹¶è¡Œæ£€ç´¢ (RAG + ç½‘ç»œ)</button>
      </div>

      <div id="ragStatus"></div>
      <div id="ragResults"></div>
    </div>

    <!-- åŸå§‹å“åº” -->
    <div class="card" id="rawResponseCard" style="display: none;">
      <h2 class="section-title">åŸå§‹å“åº”æ•°æ®</h2>
      <pre id="rawResponse"></pre>
    </div>
  </div>

  <script>
    const RAG_API_BASE = 'http://localhost:8001';
    const BOCHA_API_KEY = 'YOUR_BOCHA_API_KEY'; // è¯·æ›¿æ¢ä¸ºä½ çš„åšæŸ¥ API Key
    const BOCHA_API_BASE = 'https://api.bocha.cn/v1';

    // åšæŸ¥æœç´¢
    async function searchBocha(query, count = 5) {
      try {
        const response = await fetch(`${BOCHA_API_BASE}/web-search`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${BOCHA_API_KEY}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            query: query,
            freshness: 'noLimit',
            summary: true,
            count: count,
          }),
        });

        if (!response.ok) {
          throw new Error(`åšæŸ¥æœç´¢ API é”™è¯¯: ${response.status}`);
        }

        const data = await response.json();

        if (data.code !== 200) {
          throw new Error(`åšæŸ¥æœç´¢å¤±è´¥: ${data.msg || 'æœªçŸ¥é”™è¯¯'}`);
        }

        return data.data?.webPages?.value || [];
      } catch (error) {
        console.error('åšæŸ¥æœç´¢å¤±è´¥:', error);
        return [];
      }
    }

    // å¥åº·æ£€æŸ¥
    async function checkHealth() {
      try {
        const response = await fetch(`${RAG_API_BASE}/healthcheck`);
        const data = await response.json();
        
        document.getElementById('statusValue').textContent = data.status === 'healthy' ? 'âœ… æ­£å¸¸' : 'âŒ å¼‚å¸¸';
        document.getElementById('sdkValue').textContent = data.sdk_available ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨';
        document.getElementById('clientValue').textContent = data.client_ready ? 'âœ… å°±ç»ª' : 'âŒ æœªå°±ç»ª';
      } catch (error) {
        document.getElementById('statusValue').textContent = 'âŒ é”™è¯¯';
        document.getElementById('sdkValue').textContent = '-';
        document.getElementById('clientValue').textContent = '-';
        console.error('å¥åº·æ£€æŸ¥å¤±è´¥:', error);
      }
    }

    // è®¾ç½®æŸ¥è¯¢
    function setQuery(query) {
      document.getElementById('ragQuery').value = query;
    }

    // æ˜¾ç¤ºçŠ¶æ€
    function showStatus(elementId, message, type) {
      const statusEl = document.getElementById(elementId);
      statusEl.className = `status ${type}`;
      statusEl.textContent = message;
      statusEl.style.display = 'block';
    }

    // éšè—çŠ¶æ€
    function hideStatus(elementId) {
      document.getElementById(elementId).style.display = 'none';
    }

    // RAG æ£€ç´¢
    async function searchRAG() {
      const query = document.getElementById('ragQuery').value.trim();
      const topK = parseInt(document.getElementById('topK').value);
      
      if (!query) {
        alert('è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹');
        return;
      }

      const btn = document.getElementById('ragBtn');
      btn.disabled = true;
      btn.textContent = 'ğŸ”„ æ£€ç´¢ä¸­...';

      showStatus('ragStatus', 'æ­£åœ¨æ£€ç´¢ RAG çŸ¥è¯†åº“...', 'loading');
      document.getElementById('ragResults').innerHTML = '';
      document.getElementById('rawResponseCard').style.display = 'none';

      try {
        const startTime = Date.now();
        const response = await fetch(`${RAG_API_BASE}/api/rag/search`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            query: query,
            top_k: topK,
            enable_reranking: false,
          }),
        });

        const data = await response.json();
        const duration = ((Date.now() - startTime) / 1000).toFixed(2);

        // æ˜¾ç¤ºåŸå§‹å“åº”
        document.getElementById('rawResponse').textContent = JSON.stringify(data, null, 2);
        document.getElementById('rawResponseCard').style.display = 'block';

        if (!data.success) {
          showStatus('ragStatus', `âŒ æ£€ç´¢å¤±è´¥: ${data.message}`, 'error');
          return;
        }

        showStatus('ragStatus', `âœ… æ£€ç´¢æˆåŠŸï¼æ‰¾åˆ° ${data.nodes.length} æ¡ç»“æœï¼Œè€—æ—¶ ${duration} ç§’`, 'success');

        // æ˜¾ç¤ºç»“æœ
        displayResults('ragResults', data.nodes);

      } catch (error) {
        showStatus('ragStatus', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
        console.error('RAG æ£€ç´¢å¤±è´¥:', error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ” æ£€ç´¢ RAG';
      }
    }

    // å¹¶è¡Œæ£€ç´¢ (RAG + ç½‘ç»œ)
    async function searchKnowledge() {
      const query = document.getElementById('ragQuery').value.trim();
      
      if (!query) {
        alert('è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹');
        return;
      }

      const btn = document.getElementById('knowledgeBtn');
      btn.disabled = true;
      btn.textContent = 'ğŸ”„ æ£€ç´¢ä¸­...';

      showStatus('ragStatus', 'æ­£åœ¨å¹¶è¡Œæ£€ç´¢ RAG çŸ¥è¯†åº“ + ç½‘ç»œèµ„æº...', 'loading');
      document.getElementById('ragResults').innerHTML = '';
      document.getElementById('rawResponseCard').style.display = 'none';

      try {
        const startTime = Date.now();
        
        // çœŸå®çš„å¹¶è¡Œè°ƒç”¨ï¼šRAG + åšæŸ¥æœç´¢
        const [ragResult, webResult] = await Promise.allSettled([
          fetch(`${RAG_API_BASE}/api/rag/search`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              query: query,
              top_k: 5,
              enable_reranking: false,
            }),
          }).then(r => r.json()),
          
          searchBocha(query, 5)
        ]);

        const duration = ((Date.now() - startTime) / 1000).toFixed(2);

        const ragData = ragResult.status === 'fulfilled' ? ragResult.value : null;
        const webData = webResult.status === 'fulfilled' ? webResult.value : [];

        // æ˜¾ç¤ºåŸå§‹å“åº”
        document.getElementById('rawResponse').textContent = JSON.stringify({
          rag: ragData,
          web: webData,
        }, null, 2);
        document.getElementById('rawResponseCard').style.display = 'block';

        const ragCount = ragData?.success ? ragData.nodes.length : 0;
        const webCount = Array.isArray(webData) ? webData.length : 0;

        showStatus('ragStatus', `âœ… å¹¶è¡Œæ£€ç´¢æˆåŠŸï¼RAG: ${ragCount} æ¡ï¼Œç½‘ç»œ: ${webCount} æ¡ï¼Œè€—æ—¶ ${duration} ç§’`, 'success');
        
        let html = '';

        // æ˜¾ç¤º RAG ç»“æœ
        if (ragData && ragData.success && ragData.nodes.length > 0) {
          html += '<h3 style="margin-top: 20px; color: #667eea;">ã€ä¸“ä¸šçŸ¥è¯†åº“ - RAGã€‘</h3>';
          html += '<div class="results">';
          ragData.nodes.forEach((node, index) => {
            html += formatRAGResultItem(node, index);
          });
          html += '</div>';
        }

        // æ˜¾ç¤ºç½‘ç»œæœç´¢ç»“æœ
        if (webData && webData.length > 0) {
          html += '<h3 style="margin-top: 30px; color: #11998e;">ã€ç½‘ç»œèµ„æº - åšæŸ¥æœç´¢ã€‘</h3>';
          html += '<div class="results">';
          webData.forEach((result, index) => {
            html += formatWebResultItem(result, index);
          });
          html += '</div>';
        }

        if (!html) {
          html = '<p style="color: #666; text-align: center; padding: 20px;">æœªæ‰¾åˆ°ç›¸å…³ç»“æœ</p>';
        }

        document.getElementById('ragResults').innerHTML = html;

      } catch (error) {
        showStatus('ragStatus', `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
        console.error('å¹¶è¡Œæ£€ç´¢å¤±è´¥:', error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸŒ å¹¶è¡Œæ£€ç´¢ (RAG + ç½‘ç»œ)';
      }
    }

    // æ ¼å¼åŒ– RAG ç»“æœé¡¹
    function formatRAGResultItem(node, index) {
      const score = ((node.score || 0) * 100).toFixed(1);
      const docName = node.metadata?.doc_name || node.metadata?.title || 'æœªçŸ¥æ–‡æ¡£';
      
      return `
        <div class="result-item">
          <div class="result-header">
            <strong>${index + 1}. ${docName}</strong>
            <span class="result-score">ç›¸å…³åº¦: ${score}%</span>
          </div>
          <div class="result-text">${node.text}</div>
          <div class="result-source">æ¥æº: ${docName}</div>
        </div>
      `;
    }

    // æ ¼å¼åŒ–ç½‘ç»œæœç´¢ç»“æœé¡¹
    function formatWebResultItem(result, index) {
      const summary = result.summary || result.snippet || 'æ— æ‘˜è¦';
      const siteName = result.siteName || 'æœªçŸ¥ç½‘ç«™';
      
      return `
        <div class="result-item" style="border-left-color: #11998e;">
          <div class="result-header">
            <strong>${index + 1}. ${result.name}</strong>
            <span class="result-score" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">ç½‘ç»œèµ„æº</span>
          </div>
          <div class="result-text">${summary}</div>
          <div class="result-source">
            æ¥æº: ${siteName} 
            <a href="${result.url}" target="_blank" style="color: #11998e; text-decoration: none; margin-left: 10px;">ğŸ”— æŸ¥çœ‹åŸæ–‡</a>
          </div>
        </div>
      `;
    }

    // æ˜¾ç¤ºç»“æœ
    function displayResults(elementId, nodes) {
      const resultsEl = document.getElementById(elementId);
      
      if (nodes.length === 0) {
        resultsEl.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">æœªæ‰¾åˆ°ç›¸å…³ç»“æœ</p>';
        return;
      }

      let html = '<div class="results">';
      nodes.forEach((node, index) => {
        html += formatRAGResultItem(node, index);
      });
      html += '</div>';

      resultsEl.innerHTML = html;
    }

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥å¥åº·çŠ¶æ€
    window.onload = function() {
      checkHealth();
    };
  </script>
</body>
</html>
